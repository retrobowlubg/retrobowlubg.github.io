"use strict";window.DOMHandler=class{constructor(a,b){this._iRuntime=a,this._componentId=b,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(a,b,c,d){this._iRuntime.PostToRuntimeComponent(this._componentId,a,b,c,d)}PostToRuntimeAsync(a,b,c,d){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,a,b,c,d)}_PostToRuntimeMaybeSync(a,b,c){this._iRuntime.UsesWorker()?this.PostToRuntime(a,b,c):this._iRuntime._GetLocalRuntime()["_OnMessageFromDOM"]({"type":"event","component":this._componentId,"handler":a,"dispatchOpts":c||null,"data":b,"responseId":null})}AddRuntimeMessageHandler(a,b){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,a,b)}AddRuntimeMessageHandlers(a){for(const[b,c]of a)this.AddRuntimeMessageHandler(b,c)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}};

"use strict";window.DOMElementHandler=class extends DOMHandler{constructor(a,b){super(a,b),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandler("create",(a)=>this._OnCreate(a)),this.AddRuntimeMessageHandler("destroy",(a)=>this._OnDestroy(a)),this.AddRuntimeMessageHandler("set-visible",(a)=>this._OnSetVisible(a)),this.AddRuntimeMessageHandler("update-position",(a)=>this._OnUpdatePosition(a)),this.AddRuntimeMessageHandler("update-state",(a)=>this._OnUpdateState(a)),this.AddRuntimeMessageHandler("focus",(a)=>this._OnSetFocus(a)),this.AddRuntimeMessageHandler("set-css-style",(a)=>this._OnSetCssStyle(a))}SetAutoAttach(a){this._autoAttach=!!a}AddDOMElementMessageHandler(a,b){this.AddRuntimeMessageHandler(a,(a)=>{const c=a["elementId"],d=this._elementMap.get(c);return b(d,a)})}_OnCreate(a){const b=a["elementId"],c=this.CreateElement(b,a);this._elementMap.set(b,c),a["isVisible"]||(c.style.display="none"),this._autoAttach&&document.body.appendChild(c)}CreateElement(){throw new Error("required override")}DestroyElement(){}_OnDestroy(a){const b=a["elementId"],c=this._elementMap.get(b);this.DestroyElement(c),this._autoAttach&&c.parentElement.removeChild(c),this._elementMap.delete(b)}PostToRuntimeElement(a,b,c){c||(c={}),c["elementId"]=b,this.PostToRuntime(a,c)}_PostToRuntimeElementMaybeSync(a,b,c){c||(c={}),c["elementId"]=b,this._PostToRuntimeMaybeSync(a,c)}_OnSetVisible(a){if(this._autoAttach){const b=this._elementMap.get(a["elementId"]);b.style.display=a["isVisible"]?"":"none"}}_OnUpdatePosition(a){if(this._autoAttach){const b=this._elementMap.get(a["elementId"]);b.style.left=a["left"]+"px",b.style.top=a["top"]+"px",b.style.width=a["width"]+"px",b.style.height=a["height"]+"px";const c=a["fontSize"];null!==c&&(b.style.fontSize=c+"em")}}_OnUpdateState(a){const b=this._elementMap.get(a["elementId"]);this.UpdateState(b,a)}UpdateState(){throw new Error("required override")}_OnSetFocus(a){const b=this._elementMap.get(a["elementId"]);a["focus"]?b.focus():b.blur()}_OnSetCssStyle(a){const b=this._elementMap.get(a["elementId"]);b.style[a["prop"]]=a["val"]}GetElementById(a){return this._elementMap.get(a)}};

"use strict";{function a(a){return new Promise((b,c)=>{const d=document.createElement("script");d.onload=b,d.onerror=c,d.async=!1,d.src=a,document.head.appendChild(d)})}async function b(a){const b=await c(a),d=new TextDecoder("utf-8");return d.decode(b)}function c(a){return new Promise((b,c)=>{const d=new FileReader;d.onload=(a)=>b(a.target.result),d.onerror=(a)=>c(a),d.readAsArrayBuffer(a)})}const d=/(iphone|ipod|ipad)/i.test(navigator.userAgent);let e=new Audio;const f={"audio/webm; codecs=opus":!!e.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!e.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!e.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!e.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!e.canPlayType("audio/mp4"),"audio/mpeg":!!e.canPlayType("audio/mpeg")};e=null;const g=[];let h=0;window["RealFile"]=window["File"];const i=[],j=new Map,k=new Map;let l=0;const m=[];self.runOnStartup=function(a){if("function"!=typeof a)throw new Error("runOnStartup called without a function");m.push(a)},window.RuntimeInterface=class e{constructor(a){this._useWorker=a.useWorker,this._messageChannelPort=null,this._baseUrl="",this._scriptFolder=a.scriptFolder,this._workerScriptBlobURLs={},this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._canvas=null,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=[],this._exportType=a.exportType,("cordova"===this._exportType||"playable-ad"===this._exportType||"instant-games"===this._exportType)&&this._useWorker&&(console.warn("[C3 runtime] Worker mode is enabled and supported, but is disabled in WebViews due to crbug.com/923007. Reverting to DOM mode."),this._useWorker=!1),/CrOS/.test(navigator.userAgent)&&(console.warn("[C3 runtime] Worker mode is enabled and supported, but is disabled in Chrome OS due to reports of crashes. Reverting to DOM mode."),this._useWorker=!1),this._transferablesBroken=!1,this._localFileBlobs=null,("html5"===this._exportType||"playable-ad"===this._exportType)&&"file"===location.protocol.substr(0,4)&&alert("Exported games won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)"),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",(a)=>this._OnCordovaFetchLocalFile(a)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",(a)=>this._OnCreateJobWorker(a)),"cordova"===this._exportType?document.addEventListener("deviceready",()=>this._Init(a)):this._Init(a)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null),this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetBaseURL(){return this._baseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsWKWebView(){return"cordova"===this._exportType&&d}IsAndroid(){return"cordova"===this._exportType&&!1===d}async _Init(a){if("playable-ad"===this._exportType){this._localFileBlobs=self["c3_base64files"],await this._ConvertDataUrisToBlobs();for(let b=0,c=a.engineScripts.length;b<c;++b){const c=a.engineScripts[b].toLowerCase();this._localFileBlobs.hasOwnProperty(c)&&(a.engineScripts[b]=URL.createObjectURL(this._localFileBlobs[c]))}}if(a.baseUrl)this._baseUrl=a.baseUrl;else{const a=location.origin;this._baseUrl=("null"===a?"file:///":a)+location.pathname;const b=this._baseUrl.lastIndexOf("/");-1!==b&&(this._baseUrl=this._baseUrl.substr(0,b+1))}if(a.workerScripts)for(const[b,c]of Object.entries(a.workerScripts))this._workerScriptBlobURLs[b]=URL.createObjectURL(c);const b=new MessageChannel;this._messageChannelPort=b.port1,this._messageChannelPort.onmessage=(a)=>this["_OnMessageFromRuntime"](a.data),window["c3_addPortMessageHandler"]&&window["c3_addPortMessageHandler"]((a)=>this._OnMessageFromDebugger(a)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),this.MaybeForceBodySize(),"object"==typeof window["StatusBar"]&&window["StatusBar"]["hide"](),"object"==typeof window["AndroidFullScreen"]&&window["AndroidFullScreen"]["immersiveMode"](),await this._TestTransferablesWork(),this._useWorker?await this._InitWorker(a,b.port2):await this._InitDOM(a,b.port2)}_GetWorkerURL(a){return this._workerScriptBlobURLs.hasOwnProperty(a)?this._workerScriptBlobURLs[a]:a.endsWith("/workermain.js")&&this._workerScriptBlobURLs.hasOwnProperty("workermain.js")?this._workerScriptBlobURLs["workermain.js"]:"playable-ad"===this._exportType&&this._localFileBlobs.hasOwnProperty(a.toLowerCase())?URL.createObjectURL(this._localFileBlobs[a.toLowerCase()]):a}async CreateWorker(a,b,c){if(a.startsWith("blob:"))return new Worker(a,c);if(this.IsWKWebView()){const b=await this.CordovaFetchLocalFileAsArrayBuffer(this._scriptFolder+a),d=new Blob([b],{type:"application/javascript"});return new Worker(URL.createObjectURL(d),c)}const d=new URL(a,b),e=location.origin!==d.origin;if(e){const a=await fetch(d);if(!a.ok)throw new Error("failed to fetch worker script");const b=await a.blob();return new Worker(URL.createObjectURL(b),c)}return new Worker(d,c)}MaybeForceBodySize(){if(this.IsWKWebView()){const a=document["documentElement"].style,b=document["body"].style,c=window.innerWidth<window.innerHeight,d=c?window["screen"]["width"]:window["screen"]["height"],e=c?window["screen"]["height"]:window["screen"]["width"];b["height"]=a["height"]=e+"px",b["width"]=a["width"]=d+"px"}}_GetCommonRuntimeOptions(a){return{"baseUrl":this._baseUrl,"windowInnerWidth":window.innerWidth,"windowInnerHeight":window.innerHeight,"devicePixelRatio":window.devicePixelRatio,"isFullscreen":e.IsDocumentFullscreen(),"projectData":a.projectData,"previewImageBlobs":window["cr_previewImageBlobs"]||this._localFileBlobs,"previewProjectFileBlobs":window["cr_previewProjectFileBlobs"],"exportType":a.exportType,"isDebug":-1<self.location.search.indexOf("debug"),"ife":!!self.ife,"jobScheduler":this._jobScheduler.GetPortData(),"supportedAudioFormats":f,"opusWasmScriptUrl":window["cr_opusWasmScriptUrl"]||this._scriptFolder+"opus.wasm.js","opusWasmBinaryUrl":window["cr_opusWasmBinaryUrl"]||this._scriptFolder+"opus.wasm.wasm","isWKWebView":this.IsWKWebView(),"isFBInstantAvailable":"undefined"!=typeof self["FBInstant"]}}async _InitWorker(a,b){const c=this._GetWorkerURL(a.workerMainUrl);this._worker=await this.CreateWorker(c,this._baseUrl,{name:"Runtime"}),this._canvas=document.createElement("canvas"),this._canvas.style.display="none";const d=this._canvas["transferControlToOffscreen"]();document.body.appendChild(this._canvas),window["c3canvas"]=this._canvas,this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(a),{"type":"init-runtime","isInWorker":!0,"messagePort":b,"canvas":d,"workerDependencyScripts":a.workerDependencyScripts||[],"engineScripts":a.engineScripts,"projectScripts":window.cr_allProjectScripts,"projectScriptsStatus":self["C3_ProjectScriptsStatus"]}),[b,d,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=i.map((a)=>new a(this)),this._FindRuntimeDOMHandler(),self["c3_callFunction"]=(a,b)=>this._runtimeDomHandler._InvokeFunctionFromJS(a,b),"preview"===this._exportType&&(self["goToLastErrorScript"]=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(b,c){this._canvas=document.createElement("canvas"),this._canvas.style.display="none",document.body.appendChild(this._canvas),window["c3canvas"]=this._canvas,this._domHandlers=i.map((a)=>new a(this)),this._FindRuntimeDOMHandler();const d=b.engineScripts.map((a)=>new URL(a,this._baseUrl).toString());if(Array.isArray(b.workerDependencyScripts)&&d.unshift(...b.workerDependencyScripts),await Promise.all(d.map((b)=>a(b))),b.projectScripts&&0<b.projectScripts.length){const c=self["C3_ProjectScriptsStatus"];try{if(await Promise.all(b.projectScripts.map((b)=>a(b[1]))),Object.values(c).some((a)=>!a))return void self.setTimeout(()=>this._ReportProjectScriptError(c),100)}catch(a){return console.error("[Preview] Error loading project scripts: ",a),void self.setTimeout(()=>this._ReportProjectScriptError(c),100)}}if("preview"===this._exportType&&"object"!=typeof self.C3.ScriptsInEvents){return console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),void alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.")}const e=Object.assign(this._GetCommonRuntimeOptions(b),{"isInWorker":!1,"messagePort":c,"canvas":this._canvas,"runOnStartupFunctions":m});this._localRuntime=self["C3_CreateRuntime"](e),await self["C3_InitRuntime"](this._localRuntime,e)}_ReportProjectScriptError(a){const b=Object.entries(a).filter((a)=>!a[1]).map((a)=>a[0]),c=`Failed to load project script '${b[0]}'. Check all your JavaScript code has valid syntax.`;console.error("[Preview] "+c),alert(c)}async _OnCreateJobWorker(){const a=await this._jobScheduler._CreateJobWorker();return{"outputPort":a,"transferables":[a]}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(a,b,c,d,e){this._messageChannelPort.postMessage({"type":"event","component":a,"handler":b,"dispatchOpts":d||null,"data":c,"responseId":null},this._transferablesBroken?void 0:e)}PostToRuntimeComponentAsync(a,b,c,d,e){const f=l++,g=new Promise((a,b)=>{k.set(f,{resolve:a,reject:b})});return this._messageChannelPort.postMessage({"type":"event","component":a,"handler":b,"dispatchOpts":d||null,"data":c,"responseId":f},this._transferablesBroken?void 0:e),g}["_OnMessageFromRuntime"](a){const b=a["type"];if("event"===b)this._OnEventFromRuntime(a);else if("result"===b)this._OnResultFromRuntime(a);else if("runtime-ready"===b)this._OnRuntimeReady();else if("alert"===b)alert(a["message"]);else throw new Error(`unknown message '${b}'`)}_OnEventFromRuntime(a){const b=a["component"],c=a["handler"],d=a["data"],e=a["responseId"],f=j.get(b);if(!f)return void console.warn(`[DOM] No event handlers for component '${b}'`);const g=f.get(c);if(!g)return void console.warn(`[DOM] No handler '${c}' for component '${b}'`);let h=null;try{h=g(d)}catch(a){return console.error(`Exception in '${b}' handler '${c}':`,a),void(null!==e&&this._PostResultToRuntime(e,!1,a.toString()))}null!==e&&(h&&h.then?h.then((a)=>this._PostResultToRuntime(e,!0,a)).catch((a)=>{console.error(`Rejection from '${b}' handler '${c}':`,a),this._PostResultToRuntime(e,!1,a.toString())}):this._PostResultToRuntime(e,!0,h))}_PostResultToRuntime(a,b,c){let d;c&&c["transferables"]&&(d=c["transferables"]),this._messageChannelPort.postMessage({"type":"result","responseId":a,"isOk":b,"result":c},d)}_OnResultFromRuntime(a){const b=a["responseId"],c=a["isOk"],d=a["result"],e=k.get(b);c?e.resolve(d):e.reject(d),k.delete(b)}AddRuntimeComponentMessageHandler(a,b,c){let d=j.get(a);if(d||(d=new Map,j.set(a,d)),d.has(b))throw new Error(`[DOM] Component '${a}' already has handler '${b}'`);d.set(b,c)}static AddDOMHandlerClass(a){if(i.includes(a))throw new Error("DOM handler already added");i.push(a)}_FindRuntimeDOMHandler(){for(const a of this._domHandlers)if("runtime"===a.GetComponentID())return void(this._runtimeDomHandler=a);throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(a){this.PostToRuntimeComponent("debugger","message",a)}_OnRuntimeReady(){for(const a of this._domHandlers)a.Attach()}static IsDocumentFullscreen(){return!!(document["fullscreenElement"]||document["webkitFullscreenElement"]||document["mozFullScreenElement"])}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(a){this._rafCallbacks.push(a),this._RequestAnimationFrame()}_RemoveRAFCallback(a){const b=this._rafCallbacks.indexOf(a);if(-1===b)throw new Error("invalid callback");this._rafCallbacks.splice(b,1),this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const a of this._rafCallbacks)a();this._RequestAnimationFrame()}TryPlayMedia(a){this._runtimeDomHandler.TryPlayMedia(a)}RemovePendingPlay(a){this._runtimeDomHandler.RemovePendingPlay(a)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(a){this._runtimeDomHandler.SetSilent(a)}IsAudioFormatSupported(a){return!!f[a]}async _WasmDecodeWebMOpus(a){const b=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{"arrayBuffer":a},null,[a]);return new Float32Array(b)}IsAbsoluteURL(a){return /^(?:[a-z]+:)?\/\//.test(a)||"data:"===a.substr(0,5)||"blob:"===a.substr(0,5)}IsRelativeURL(a){return!this.IsAbsoluteURL(a)}async _OnCordovaFetchLocalFile(a){const b=a["filename"];switch(a["as"]){case"text":return await this.CordovaFetchLocalFileAsText(b);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(b);default:throw new Error("unsupported type");}}CordovaFetchLocalFile(a){const b=window["cordova"]["file"]["applicationDirectory"]+"www/"+a.toLowerCase();return new Promise((a,c)=>{window["resolveLocalFileSystemURL"](b,(b)=>{b["file"](a,c)},c)})}async CordovaFetchLocalFileAsText(a){const c=await this.CordovaFetchLocalFile(a);return await b(c)}_CordovaMaybeStartNextArrayBufferRead(){if(g.length&&!(h>=8)){h++;const a=g.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(a.filename,a.successCallback,a.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(a){return new Promise((b,c)=>{g.push({filename:a,successCallback:(a)=>{h--,this._CordovaMaybeStartNextArrayBufferRead(),b(a)},errorCallback:(a)=>{h--,this._CordovaMaybeStartNextArrayBufferRead(),c(a)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(a,b,d){try{const d=await this.CordovaFetchLocalFile(a),e=await c(d);b(e)}catch(a){d(a)}}async _ConvertDataUrisToBlobs(){const a=[];for(const[b,c]of Object.entries(this._localFileBlobs))a.push(this._ConvertDataUriToBlobs(b,c));await Promise.all(a)}async _ConvertDataUriToBlobs(a,b){if("object"==typeof b)this._localFileBlobs[a]=new Blob([b["str"]],{"type":b["type"]});else{const c=await fetch(b),d=await c.blob();this._localFileBlobs[a]=d}}_TestTransferablesWork(){let a=null;const b=new Promise((b)=>a=b),c=new ArrayBuffer(1),d=new MessageChannel;return d.port2.onmessage=(b)=>{b.data&&b.data["arrayBuffer"]||(this._transferablesBroken=!0,console.warn("MessageChannel transfers determined to be broken. Disabling transferables.")),a()},d.port1.postMessage({"arrayBuffer":c},[c]),b}}}

"use strict";{function a(a){return a["sourceCapabilities"]&&a["sourceCapabilities"]["firesTouchEvents"]||a["originalEvent"]&&a["originalEvent"]["sourceCapabilities"]&&a["originalEvent"]["sourceCapabilities"]["firesTouchEvents"]}function b(a){return new Promise((b,c)=>{const d=document.createElement("link");d.onload=()=>b(d),d.onerror=(a)=>c(a),d.rel="stylesheet",d.href=a,document.head.appendChild(d)})}function c(a){return new Promise((b,c)=>{const d=new Image;d.onload=()=>b(d),d.onerror=(a)=>c(a),d.src=a})}async function d(a){const b=URL.createObjectURL(a);try{return await c(b)}finally{URL.revokeObjectURL(b)}}function f(a){do{if(a.parentNode&&a.hasAttribute("contenteditable"))return!0;a=a.parentNode}while(a);return!1}function e(a){const b=a.target.tagName.toLowerCase();m.has(b)&&a.preventDefault()}function g(a){(a.metaKey||a.ctrlKey)&&a.preventDefault()}function h(){try{return window.parent&&window.parent.document.hasFocus()}catch(a){return!1}}const i=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),j={"dispatchRuntimeEvent":!0,"dispatchUserScriptEvent":!0},k={"dispatchUserScriptEvent":!0},l={"dispatchRuntimeEvent":!0};const m=new Set(["canvas","body","html"]);self["C3_RasterSvgImage"]=async function(a,b,c){const d=document.createElement("canvas");d.width=b,d.height=c;const e=d.getContext("2d");return e.drawImage(a,0,0,b,c),d};let n=!1;document.addEventListener("pause",()=>n=!0),document.addEventListener("resume",()=>n=!1);const o=class extends DOMHandler{constructor(a){super(a,"runtime"),this._isFirstSizeUpdate=!0,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._debugHighlightElem=null,a.AddRuntimeComponentMessageHandler("canvas","update-size",(a)=>this._OnUpdateCanvasSize(a)),a.AddRuntimeComponentMessageHandler("runtime","invoke-download",(a)=>this._OnInvokeDownload(a)),a.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",(a)=>this._OnRasterSvgImage(a)),a.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",(a)=>this._OnSetTargetOrientation(a)),a.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),a.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",(a)=>this._OnPostToDebugger(a)),a.AddRuntimeComponentMessageHandler("runtime","go-to-script",(a)=>this._OnPostToDebugger(a)),a.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),a.AddRuntimeComponentMessageHandler("runtime","debug-highlight",(a)=>this._OnDebugHighlight(a)),a.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),a.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),a.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",(a)=>this._OnAddStylesheet(a));const b=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",(a)=>{const c=a.target,d=c.tagName.toLowerCase();b.has(d)||f(c)||a.preventDefault()}),window.addEventListener("selectstart",e),window.addEventListener("gesturehold",e),window.addEventListener("touchstart",e,{"passive":!1});const c=a.GetCanvas();"undefined"==typeof PointerEvent?c.addEventListener("touchstart",e):(window.addEventListener("pointerdown",e,{"passive":!1}),c.addEventListener("pointerdown",e)),this._mousePointerLastButtons=0,window.addEventListener("mousedown",(a)=>{1===a.button&&a.preventDefault()}),window.addEventListener("mousewheel",g,{"passive":!1}),window.addEventListener("wheel",g,{"passive":!1}),window.addEventListener("resize",()=>this._OnWindowResize()),this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_OnBeforeStartTicking(){return"cordova"===this._iRuntime.GetExportType()?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden)),{"isSuspended":!!(document.hidden||n)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{"parentHasFocus":h()}),this._mousePointerLastButtons=0}),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",(a)=>this._OnFullscreenError(a)),window.addEventListener("webkitfullscreenerror",(a)=>this._OnFullscreenError(a)),window.addEventListener("mozfullscreenerror",(a)=>this._OnFullscreenError(a)),window.addEventListener("keydown",(a)=>this._OnKeyEvent("keydown",a)),window.addEventListener("keyup",(a)=>this._OnKeyEvent("keyup",a)),window.addEventListener("dblclick",(a)=>this._OnMouseEvent("dblclick",a,j)),window.addEventListener("wheel",(a)=>this._OnMouseWheelEvent("wheel",a)),"undefined"==typeof PointerEvent?(window.addEventListener("mousedown",(a)=>this._OnMouseEventAsPointer("pointerdown",a)),window.addEventListener("mousemove",(a)=>this._OnMouseEventAsPointer("pointermove",a)),window.addEventListener("mouseup",(a)=>this._OnMouseEventAsPointer("pointerup",a)),window.addEventListener("touchstart",(a)=>this._OnTouchEvent("pointerdown",a)),window.addEventListener("touchmove",(a)=>this._OnTouchEvent("pointermove",a)),window.addEventListener("touchend",(a)=>this._OnTouchEvent("pointerup",a)),window.addEventListener("touchcancel",(a)=>this._OnTouchEvent("pointercancel",a))):(window.addEventListener("pointerdown",(a)=>this._OnPointerEvent("pointerdown",a)),window.addEventListener("pointermove",(a)=>this._OnPointerEvent("pointermove",a)),window.addEventListener("pointerup",(a)=>this._OnPointerEvent("pointerup",a)),window.addEventListener("pointercancel",(a)=>this._OnPointerEvent("pointercancel",a)));const a=()=>this._PlayPendingMedia();window.addEventListener("pointerup",a,!0),window.addEventListener("touchend",a,!0),window.addEventListener("click",a,!0),window.addEventListener("keydown",a,!0),window.addEventListener("gamepadconnected",a,!0)}_PostRuntimeEvent(a,b){this.PostToRuntime(a,b||null,l)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_OnWindowResize(){const a=this._GetWindowInnerWidth(),b=this._GetWindowInnerHeight();this._PostRuntimeEvent("window-resize",{"innerWidth":a,"innerHeight":b,"devicePixelRatio":window.devicePixelRatio}),this._iRuntime.IsWKWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(a,b,0))}_ScheduleSimulatedResize(a,b,c){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(a,b,c),48)}_OnSimulatedResize(a,b,c){const d=this._GetWindowInnerWidth(),e=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,d!=a||e!=b?this._PostRuntimeEvent("window-resize",{"innerWidth":d,"innerHeight":e,"devicePixelRatio":window.devicePixelRatio}):10>c&&this._ScheduleSimulatedResize(d,e,c+1)}_OnSetTargetOrientation(a){this._targetOrientation=a["targetOrientation"]}_TrySetTargetOrientation(){const a=this._targetOrientation;if(screen["orientation"]&&screen["orientation"]["lock"])screen["orientation"]["lock"](a).catch((a)=>console.warn("[Construct 3] Failed to lock orientation: ",a));else try{let b=!1;screen["lockOrientation"]?b=screen["lockOrientation"](a):screen["webkitLockOrientation"]?b=screen["webkitLockOrientation"](a):screen["mozLockOrientation"]?b=screen["mozLockOrientation"](a):screen["msLockOrientation"]&&(b=screen["msLockOrientation"](a)),b||console.warn("[Construct 3] Failed to lock orientation")}catch(a){console.warn("[Construct 3] Failed to lock orientation: ",a)}}_OnFullscreenChange(){const a=RuntimeInterface.IsDocumentFullscreen();a&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{"isFullscreen":a,"innerWidth":this._GetWindowInnerWidth(),"innerHeight":this._GetWindowInnerHeight()})}_OnFullscreenError(a){console.warn("[Construct 3] Fullscreen request failed: ",a),this.PostToRuntime("fullscreenerror",{"isFullscreen":RuntimeInterface.IsDocumentFullscreen(),"innerWidth":this._GetWindowInnerWidth(),"innerHeight":this._GetWindowInnerHeight()})}_OnVisibilityChange(a){a?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{"hidden":a})}_OnKeyEvent(a,b){const c=i.get(b.code)||b.code;this._PostToRuntimeMaybeSync(a,{"code":c,"key":b.key,"which":b.which,"repeat":b.repeat,"altKey":b.altKey,"ctrlKey":b.ctrlKey,"metaKey":b.metaKey,"shiftKey":b.shiftKey,"timeStamp":b.timeStamp},j)}_OnMouseWheelEvent(a,b){this.PostToRuntime(a,{"clientX":b.clientX,"clientY":b.clientY,"deltaX":b.deltaX,"deltaY":b.deltaY,"deltaZ":b.deltaZ,"deltaMode":b.deltaMode,"timeStamp":b.timeStamp},j)}_OnMouseEvent(b,c,d){a(c)||("mousedown"===b&&window!==window.top&&window.focus(),this._PostToRuntimeMaybeSync(b,{"button":c.button,"buttons":c.buttons,"clientX":c.clientX,"clientY":c.clientY,"timeStamp":c.timeStamp},d))}_OnMouseEventAsPointer(b,c){if(a(c))return;"pointerdown"===b&&window!==window.top&&window.focus();const d=this._mousePointerLastButtons;"pointerdown"===b&&0!==d?b="pointermove":"pointerup"==b&&0!==c.buttons&&(b="pointermove"),this._PostToRuntimeMaybeSync(b,{"pointerId":1,"pointerType":"mouse","button":c.button,"buttons":c.buttons,"lastButtons":d,"clientX":c.clientX,"clientY":c.clientY,"width":0,"height":0,"pressure":0,"tangentialPressure":0,"tiltX":0,"tiltY":0,"twist":0,"timeStamp":c.timeStamp},j),this._mousePointerLastButtons=c.buttons,this._OnMouseEvent(c.type,c,k)}_OnPointerEvent(a,b){"pointerdown"===a&&window!==window.top&&window.focus();let c=0;if("mouse"===b.pointerType&&(c=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(a,{"pointerId":b.pointerId,"pointerType":b.pointerType,"button":b.button,"buttons":b.buttons,"lastButtons":c,"clientX":b.clientX,"clientY":b.clientY,"width":b.width||0,"height":b.height||0,"pressure":b.pressure||0,"tangentialPressure":b["tangentialPressure"]||0,"tiltX":b.tiltX||0,"tiltY":b.tiltY||0,"twist":b["twist"]||0,"timeStamp":b.timeStamp},j),"mouse"===b.pointerType){let c="mousemove";"pointerdown"===a?c="mousedown":"pointerup"==a&&(c="pointerup"),this._OnMouseEvent(c,b,k),this._mousePointerLastButtons=b.buttons}}_OnTouchEvent(a,b){"pointerdown"===a&&window!==window.top&&window.focus();for(let c=0,d=b.changedTouches.length;c<d;++c){const d=b.changedTouches[c];this._PostToRuntimeMaybeSync(a,{"pointerId":d.identifier,"pointerType":"touch","button":0,"buttons":0,"lastButtons":0,"clientX":d.clientX,"clientY":d.clientY,"width":2*(d["radiusX"]||d["webkitRadiusX"]||0),"height":2*(d["radiusY"]||d["webkitRadiusY"]||0),"pressure":d["force"]||d["webkitForce"]||0,"tangentialPressure":0,"tiltX":0,"tiltY":0,"twist":d["rotationAngle"]||0,"timeStamp":b.timeStamp},j)}}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",(a)=>this._OnDeviceOrientation(a)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",(a)=>this._OnDeviceMotion(a)))}_OnDeviceOrientation(a){this.PostToRuntime("deviceorientation",{"alpha":a["alpha"]||0,"beta":a["beta"]||0,"gamma":a["gamma"]||0,"timeStamp":a.timeStamp},j)}_OnDeviceMotion(a){let b=null;const c=a["acceleration"];c&&(b={"x":c["x"]||0,"y":c["y"]||0,"z":c["z"]||0});let d=null;const e=a["accelerationIncludingGravity"];e&&(d={"x":e["x"]||0,"y":e["y"]||0,"z":e["z"]||0});let f=null;const g=a["rotationRate"];g&&(f={"alpha":g["alpha"]||0,"beta":g["beta"]||0,"gamma":g["gamma"]||0}),this.PostToRuntime("devicemotion",{"acceleration":b,"accelerationIncludingGravity":d,"rotationRate":f,"interval":a["interval"],"timeStamp":a.timeStamp},j)}_OnUpdateCanvasSize(a){const b=this.GetRuntimeInterface(),c=b.GetCanvas();c.style.width=a["styleWidth"]+"px",c.style.height=a["styleHeight"]+"px",c.style.marginLeft=a["marginLeft"]+"px",c.style.marginTop=a["marginTop"]+"px",b.MaybeForceBodySize(),this._isFirstSizeUpdate&&(c.style.display="",this._isFirstSizeUpdate=!1)}_OnInvokeDownload(b){const c=b["url"],d=b["filename"],e=document.createElement("a"),a=document.body;e.textContent=d,e.href=c,e.download=d,a.appendChild(e),e.click(),a.removeChild(e)}async _OnRasterSvgImage(a){const b=a["blob"],c=a["width"],e=a["height"],f=await d(b),g=await self["C3_RasterSvgImage"](f,c,e);return await createImageBitmap(g)}async _OnAddStylesheet(a){await b(a["url"])}_PlayPendingMedia(){const a=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const b of a){const a=b.play();a&&a.catch(()=>{this._mediaRemovedPendingPlay.has(b)||this._mediaPendingPlay.add(b)})}}TryPlayMedia(a){if("function"!=typeof a.play)throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(a);let b;try{b=a.play()}catch(b){return void this._mediaPendingPlay.add(a)}b&&b.catch(()=>{this._mediaRemovedPendingPlay.has(a)||this._mediaPendingPlay.add(a)})}RemovePendingPlay(a){this._mediaPendingPlay.delete(a),this._mediaRemovedPendingPlay.add(a)}SetSilent(a){this._isSilent=!!a}_OnDebugHighlight(a){const b=a["show"];if(!b)return void(this._debugHighlightElem&&(this._debugHighlightElem.style.display="none"));this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const c=this._debugHighlightElem;c.style.display="",c.style.left=a["left"]-1+"px",c.style.top=a["top"]-1+"px",c.style.width=a["width"]+2+"px",c.style.height=a["height"]+2+"px",c.textContent=a["name"]}_OnRegisterSW(){window["C3_RegisterSW"]&&window["C3_RegisterSW"]()}_OnPostToDebugger(a){window["c3_postToMessagePort"]&&(a["from"]="runtime",window["c3_postToMessagePort"](a))}_InvokeFunctionFromJS(a,b){return this.PostToRuntimeAsync("js-invoke-function",{"name":a,"params":b})}};RuntimeInterface.AddDOMHandlerClass(o)}

"use strict";{const a=document.currentScript.src;self.JobSchedulerDOM=class{constructor(b){this._runtimeInterface=b,this._baseUrl=a?a.substr(0,a.lastIndexOf("/")+1):b.GetBaseURL(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const a=this._runtimeInterface._GetWorkerURL("dispatchworker.js");this._dispatchWorker=await this._runtimeInterface.CreateWorker(a,this._baseUrl,{name:"DispatchWorker"});const b=new MessageChannel;this._inputPort=b.port1,this._dispatchWorker.postMessage({"type":"_init","in-port":b.port2},[b.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const a=this._jobWorkers.length,b=this._runtimeInterface._GetWorkerURL("jobworker.js"),c=await this._runtimeInterface.CreateWorker(b,this._baseUrl,{name:"JobWorker"+a}),d=new MessageChannel,e=new MessageChannel;return this._dispatchWorker.postMessage({"type":"_addJobWorker","port":d.port1},[d.port1]),c.postMessage({"type":"init","number":a,"dispatch-port":d.port2,"output-port":e.port2},[d.port2,e.port2]),this._jobWorkers.push(c),e.port1}GetPortData(){return{"inputPort":this._inputPort,"outputPort":this._outputPort,"maxNumWorkers":this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}

"use strict";if(window["C3_IsSupported"]){const a=false,b="undefined"!=typeof OffscreenCanvas;window["c3_runtimeInterface"]=new RuntimeInterface({useWorker:a&&b,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"})}"use strict";{const a=class extends DOMHandler{constructor(a){super(a,"touch"),this.AddRuntimeMessageHandler("request-permission",(a)=>this._OnRequestPermission(a))}async _OnRequestPermission(a){const b=a["type"];let c=!0;0===b?c=await this._RequestOrientationPermission():1===b&&(c=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{"type":b,"result":c})}async _RequestOrientationPermission(){if(!self["DeviceOrientationEvent"]||!self["DeviceOrientationEvent"]["requestPermission"])return!0;try{const a=await self["DeviceOrientationEvent"]["requestPermission"]();return"granted"===a}catch(a){return console.warn("[Touch] Failed to request orientation permission: ",a),!1}}async _RequestMotionPermission(){if(!self["DeviceMotionEvent"]||!self["DeviceMotionEvent"]["requestPermission"])return!0;try{const a=await self["DeviceMotionEvent"]["requestPermission"]();return"granted"===a}catch(a){return console.warn("[Touch] Failed to request motion permission: ",a),!1}}};RuntimeInterface.AddDOMHandlerClass(a)}"use strict";{function c(b){return b%=i,0>b&&(b+=i),b}function a(c,d,a){return c<d?d:c>a?a:c}function b(c,a,b){return c+b*(a-c)}function d(c,a,b){return c===a?0:(b-c)/(a-c)}function e(a,b){var c=Math.cos,d=Math.sin;if(a===b)return 0;const e=d(a),f=c(a),g=d(b),h=c(b),i=e*g+f*h;return 1<=i?0:-1>=i?Math.PI:Math.acos(i)}function f(a,b){var c=Math.cos,d=Math.sin;const e=d(a),f=c(a),g=d(b),h=c(b);return 0>=f*g-e*h}function g(d,a,b){const g=e(d,a);return f(a,d)?c(d+g*b):c(d-g*b)}const h=[],i=2*Math.PI;class j{constructor(a,b,c,d,e,f){this._index=a,this._interp=b,this._precision=c,this._tag=d,this._userData=e,this._clientValueTag=f}GetRuntimeData(){return{"tag":this._tag,"interp":this._interp,"userData":this._userData,"cvt":this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return"undefined"!=typeof this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(b){switch(this._precision){case 0:return b;case 1:return Math.fround(b);case 2:return 2===this._interp&&(b=c(b),b/=Math.PI,b-=1,b*=32767),a(0|b,-32768,32767);case 3:return 2===this._interp&&(b=c(b),b/=i,b*=255),a(0|b,0,255);default:return b;}}Write(a,b,c){switch(this._precision){case 0:a.setFloat64(b,c),b+=8;break;case 1:a.setFloat32(b,c),b+=4;break;case 2:a.setInt16(b,c),b+=2;break;case 3:a.setUint8(b,c),b+=1;break;default:a.setFloat32(b,c),b+=4;}return b}MaybeUnpack(a){return 2===this._interp?2===this._precision?(a/=32767,a+=1,a*=Math.PI,a):3===this._precision?(a/=255,a*=i,a):a:a}static InterpNetValue(a,c,d,e,f){return 0===a?f?d:c:1===a?b(c,d,e):2===a?g(c,d,e):f?d:c}}class k{constructor(a,b){this.timestamp=a,this.data=b}}class l{constructor(a,b,c){this._ro=a,this._domHandler=a.GetDOMHandler(),this._id=b,this._nid=c,this._data=[],this._data.length=this._ro.GetNetValues().length,this._lastChanged=0,this._lastTransmitted=0,this._transmitMe=!1,this._isAlive=!1,this._updates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null}GetRuntimeData(){const a=[];for(let b=0,c=this._ro.GetNetValues().length;b<c;++b)a.push(this.GetInterp(this._ro.GetSimTime(),b));const b={"id":this._id,"nid":this._nid,"isTimedOut":this.IsTimedOut(),"interpValues":a,"latestUpdate":null},c=this.GetLatestUpdate();return c&&(b["latestUpdate"]={"timestamp":c.timestamp,"data":c.data}),b}GetId(){return this._id}GetNid(){return this._nid}SetAlive(b){this._isAlive=!!b}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(a,b){const c=a["netValues"],d=this._ro.GetNetValues(),e=d.length;this._transmitMe=!1;for(let f=0;f<e;++f){const a=d[f],e=a.Clamp(c[f]);this._data[f]!==e&&(this._data[f]=e,this._lastChanged=b,this._ro.SetLastChanged(b))}const f=b-this._lastChanged,g=b-this._lastTransmitted,h=this._ro.GetBandwidth();this._transmitMe=!!(100>f&&0===h)||(1e3>f&&1>=h?95<=g:495<=g),this._transmitMe&&this._ro.IncNumberToTransmit()}WriteData(a,b,c){const d=this._ro.GetNetValues();this._lastTransmitted=c,a.setUint16(b,this._nid),b+=2;for(let e=0,f=this._data.length;e<f;++e)b=d[e].Write(a,b,this._data[e]);return b}AddUpdate(a,b){for(let c=0,d=this._updates.length;c<d;++c){const d=this._updates[c];if(d.timestamp===a)return;if(d.timestamp>a)return void this._updates.splice(c,0,new k(a,b))}this._updates.push(new k(a,b))}IsTimedOut(){return 0!==this._updates.length&&this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3e3}Tick(){for(;2<this._updates.length&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();const a=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>a&&this._priorUpdate&&this._priorUpdate.timestamp<a)){this._nextUpdate=null;for(let b=0,c=this._updates.length;b<c;++b){const c=this._updates[b];if(c.timestamp<=a)(!this._priorUpdate||c.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=c);else{this._nextUpdate=c;break}}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(a,b,c){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[b];const e=this._ro.GetNetValues();let f,g,h,i,k;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2&&!c){f=this._priorUpdate2.timestamp,g=this._priorUpdate2.data[b],h=this._priorUpdate.timestamp,i=this._priorUpdate.data[b];let c=a;return c>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(c=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),k=d(f,h,c),j.InterpNetValue(e[b].GetInterp(),g,i,k,!0)}return this._priorUpdate.data[b]}return f=this._priorUpdate.timestamp,g=this._priorUpdate.data[b],h=this._nextUpdate.timestamp,i=this._nextUpdate.data[b],k=d(f,h,a),j.InterpNetValue(e[b].GetInterp(),g,i,k,!1)}}self.C3NetValue=j,self.C3NetUpdate=k,self.C3RegisteredObject=class{constructor(a,b,c,d){switch(this._domHandler=a,this._roId=b,this._sid=c,this._nid=this._domHandler.GetNextObjectNid(),this._bandwidth=d,this._userData={},this._instanceByteSize=0,this._extrapolateLimit=250,this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=2500;}this._netValues=[],this._netInstances=[],this._idToNetInst=new Map,this._usedNids=new Set,this._nextNid=0,this._lastChanged=0,this._lastTransmitted=0,this._numberToTransmit=0,this._hasOverriddenNids=!1,this._deadNids=[],this._overrideNids=new Map,this._nidToNetInst=new Map,this._simTime=0,this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(a){this._nid=a}GetNid(){return this._nid}SetLastChanged(a){this._lastChanged=a}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(a){this._hasOverriddenNids=!!a}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(a,b,c,d,e){const f=new j(this._netValues.length,a,b,c,d,e);0===b?this._instanceByteSize+=8:1===b?this._instanceByteSize+=4:2===b?this._instanceByteSize+=2:3===b?this._instanceByteSize+=1:void 0;this._netValues.push(f)}AddUpdate(a,b,c){const d=this.GetNetInstForNid(b);d.AddUpdate(a,c)}Tick(){this._simTime=this._domHandler.GetSimulationTime();for(const a of this._netInstances)a.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(a){return a=Math.floor(a),0>a||a>=this._netInstances.length?null:this._netInstances[a]}GetNetInstByNid(a){for(const b of this._netInstances)if(b.GetNid()===a)return b;return null}GetNetValuesJson(){const a=[];for(const b of this._netValues){const c={"tag":b.GetTag(),"precision":b.GetPrecision(),"interp":b.GetInterp(),"clientvaluetag":b.GetClientValueTag()};b.HasUserData()&&(c["userdata"]=b.GetUserData()),a.push(c)}return a}SetNetValuesFrom(a){this._netValues.length=0,this._instanceByteSize=0;for(const b of a)this.AddValue(b["interp"],b["precision"],b["tag"],b["userdata"],b["clientvaluetag"])}GetNetInstForNid(a){let b=this._nidToNetInst.get(a);return b?b:(b=new l(this,-1,a),this._nidToNetInst.set(a,b),this._netInstances.push(b),b)}GetNetInstForId(a){let b=this._idToNetInst.get(a);return b?b:(b=new l(this,a,this.AllocateInstanceNid()),this._idToNetInst.set(a,b),this._netInstances.push(b),b)}AllocateInstanceNid(){do this._nextNid++,65535<this._nextNid&&(this._nextNid=0);while(this._usedNids.has(this._nextNid));const a=this._nextNid;return this._usedNids.add(a),a}RemoveNetInstance(a){const b=a.GetId(),c=a.GetNid();this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(c),this._idToNetInst.delete(b),this._nidToNetInst.delete(c),this._usedNids.delete(c);const d=this._netInstances.indexOf(a);-1<d&&this._netInstances.splice(d,1)}UpdateData(a,b){this._numberToTransmit=0;for(const c of this._netInstances)c.SetAlive(!1);for(let c=0,d=a.length;c<d;++c){const e=a[c],d=e["uid"],f=this.GetNetInstForId(d);f.SetAlive(!0),f.UpdateData(e,b)}for(const c of this._netInstances)c.IsAlive()||h.push(c);for(const c of h)this.RemoveNetInstance(c);h.length=0}WriteData(a,b,c){a.setUint16(b,this._nid),b+=2;let d=0;this._hasOverriddenNids&&(d=1),a.setUint8(b,d),b+=1,a.setUint16(b,this._numberToTransmit),b+=2,a.setUint16(b,this._instanceByteSize),b+=2;for(const d of this._netInstances)d.ShouldTransmit()&&(b=d.WriteData(a,b,c));return b}OverrideNid(a,b){if(this._idToNetInst.has(a))return void console.warn("OverrideNid passed id "+a+" which is already in use and cannot be overridden");if(this._usedNids.has(b))return void console.warn("OverrideNid passed nid "+b+" which is already in use and cannot be overridden");const c=new l(this,a,b);return this._idToNetInst.set(a,c),this._usedNids.add(b),this._netInstances.push(c),this._hasOverriddenNids=!0,c}RemoveObjectId(a){const b=this._idToNetInst.get(a);b&&this.RemoveNetInstance(b)}RemoveObjectNid(a){const b=this._nidToNetInst.get(a);b&&this.RemoveNetInstance(b)}GetRuntimeData(){return{"hasOverriddenNids":this.HasOverriddenNids(),"netValues":this._netValues.map((a)=>a.GetRuntimeData()),"netInstances":this._netInstances.map((a)=>a.GetRuntimeData())}}GetRuntimeInfoRequest(){return{"roId":this._roId,"sid":this._sid,"netValues":this._netValues.map((a)=>a.GetRuntimeData())}}}}"use strict";{function a(a){if(a)try{a.close()}catch(a){}}function b(c,a,b){return c===a?0:(b-c)/(a-c)}const c=window["RTCPeerConnection"]||window["webkitRTCPeerConnection"]||window["mozRTCPeerConnection"]||window["msRTCPeerConnection"],d=[];class e{constructor(a,b,c){this._domHandler=a,this._id=b,this._nid=0,this._alias=c,this._pc=null,this._dco=null,this._isOOpen=!1,this._dcr=null,this._isROpen=!1,this._dcu=null,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._wasRemoved=!1,this._hasConfirmed=!1,this._lastHeardFrom=0,this._connectTime=0,this._errorCount=0,this._localClientState=[],this._lastStateChange=0,this._lastStateTransmit=0,this._clientStateUpdates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null,this._lastPingSent=0,this._awaitingPong=!1,this._lastSentPingId=1,this._lastPingTimes=[],this._latency=0,this._pdv=0,this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(a){this._nid=a}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(a){this._lastStateChange=a}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(a){this._lastStateTransmit=a}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}_AttachDataChannelHandlers(a,b){a.binaryType="arraybuffer",a.onopen=()=>{"o"===b?this._isOOpen=!0:"r"===b?this._isROpen=!0:"u"==b&&(this._isUOpen=!0),this._MaybeFireOpen()},a.onmessage=(a)=>{this._OnMessage(b,a)},a.onerror=(a)=>{console.error("Peer '"+this._id+"' datachannel '"+b+"' error: ",a),this._domHandler._OnPeerError(this,a),this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")},a.onclose=()=>{this.Remove("disconnect")}}Connect(){if(this.IsSelf())return;const a=this._domHandler.IsHost();this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._connectTime=performance.now(),this._pc=new c({"iceServers":this._domHandler.GetICEServerList()}),this._pc.onicecandidate=(a)=>{a.candidate&&this._domHandler.SignallingSend({"message":"icecandidate","toclientid":this._id,"icecandidate":a.candidate})},this._pc.onsignalingstatechange=()=>{this._pc&&("closed"!==this._pc.signalingState||this.Remove("disconnect"))},this._pc.oniceconnectionstatechange=()=>{this._pc&&("failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect"))};const b=`c2mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_${this._domHandler.GetCurrentRoom()}`;a?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:b}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:b}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,maxRetransmits:0,protocol:b}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then((a)=>{this._pc.setLocalDescription(a),this._domHandler.SignallingSend({"message":"offer","toclientid":this._id,"offer":a})}).catch((a)=>{console.error("Host error creating offer for peer '"+this._id+"': ",a),this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=(a)=>{if(a.channel.protocol!==b)return console.error("Unexpected datachannel protocol '"+a.channel.protocol+"', should be '"+expect_protocol+"'"),void this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+a.channel.protocol+"', should be '"+expect_protocol+"'");const c=a.channel.label;"o"===c?this._dco=a.channel:"r"===c?this._dcr=a.channel:"u"===c?this._dcu=a.channel:(console.error("Unknown datachannel label: "+a.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+a.channel.label+"'")),this._AttachDataChannelHandlers(a.channel,c)}}async _AddICECandidate(a){if(this._pc)try{await this._pc.addIceCandidate(a)}catch(a){console.warn("[Multiplayer] Error adding ICE candidate: ",a)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){this._firedOpen||this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){if(this._lastHeardFrom=performance.now(),this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({"c":"j","i":this._id,"n":this._nid,"a":this._alias}),this),this.Send("o",JSON.stringify({"c":"hi","hn":this._domHandler.GetHostPeer().GetNid(),"n":this._nid,"d":this._domHandler.GetClientDelay(),"u":this._domHandler.GetPeerUpdateRateSec(),"objs":this._domHandler.GetRegisteredObjectsMap(),"cvs":this._domHandler.GetClientValuesJson()}));for(const a of this._domHandler.peers())!a.IsHost()&&a!==this&&a.IsOpen()&&this.Send("o",JSON.stringify({"c":"j","i":a.GetId(),"n":a.GetNid(),"a":a.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0);this._domHandler._OnPeerOpen(this)}_MaybeFireClose(a){this._firedClose||!this._firedOpen||(this._OnClose(a),this._firedClose=!0,this._firedOpen=!1)}_OnClose(a){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({"c":"l","i":this._id,"a":this._alias,"r":a}),this),this.IsSelf()||this._domHandler._OnPeerClose(this,a)}IsOpen(){return this._firedOpen&&!this._firedClose}Send(a,b){this._domHandler.StatIncOutboundCount();let c=0;b.length?c=b.length:b.byteLength&&(c=b.byteLength),this._domHandler.StatAddOutboundBandwidthCount(c);const d=this._domHandler.GetSimulatedPacketLoss(),e=this._domHandler.GetSimulatedLatency(),f=this._domHandler.GetSimulatedPdv();if(!(0<d&&"u"===a&&Math.random()<d))if(0===e&&0===f)this._DoSend(a,b);else{let c=1;"u"!==a&&Math.random()<d&&(c=3),setTimeout(()=>this._DoSend(a,b),e*c+Math.random()*f*c)}}_DoSend(a,b){try{"o"===a?this._isOOpen&&this._dco&&this._dco.send(b):"r"===a?this._isROpen&&this._dcr&&this._dcr.send(b):"u"==a&&this._isUOpen&&this._dcu&&this._dcu.send(b)}catch(c){if(this._wasRemoved)return;this._domHandler.IsHost()?"o"===a||"r"===a?("string"==typeof b?(console.error("Error sending "+b.length+"-char string on '"+a+"' to '"+this._alias+"', host kicking: ",c),console.log("String that failed to send from previous error was: "+b)):console.error("Error sending "+(b.length||b.byteLength)+"-byte binary on '"+a+"' to '"+this._alias+"', host kicking: ",c),this.Remove("network error")):(this._errorCount++,10<=this._errorCount&&("string"==typeof b?(console.error("Too many errors ("+this._errorCount+") sending data on '"+a+"' to '"+this._alias+"', kicking; last error was for sending "+b.length+"-char string: ",c),console.log("String that failed to send from previous error was: "+b)):console.error("Too many errors ("+this._errorCount+") sending data on '"+a+"' to '"+this._alias+"', kicking; last error was for sending "+(b.length||b.byteLength)+"-byte binary: ",c),this.Remove("network error"))):console.error("Error sending data on '"+a+"': ",c)}}SendPing(a,b){return this._wasRemoved?void 0:!b&&!this.IsOpen()&&this._pc&&25e3<a-this._connectTime?(console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),void this.Remove("timeout")):!b&&this.IsOpen()&&2e4<a-this._lastHeardFrom?(console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),void this.Remove("timeout")):void(this._lastPingSent=a,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId))}SendPong(a){let b="pong:"+a.substr(5);this._domHandler.IsHost()&&(b+="/",b+=Math.round(performance.now()).toString()),this.Send("u",b)}_OnPong(a){if(!this._awaitingPong)return;const b=a.indexOf(":");if(-1<b){const c=parseFloat(a.substr(b+1));if(c!==this._lastSentPingId)return}else return void console.warn("Cannot parse off ping ID from pong");const c=performance.now();this._awaitingPong=!1;const e=(c-this._lastPingSent)/2;this._lastPingTimes.push(e),10<this._lastPingTimes.length&&this._lastPingTimes.shift(),d.push(...this._lastPingTimes),d.sort((c,a)=>c-a),this._pdv=d[d.length-1]-d[0];let f=0,g=d.length;4<=d.length&&6>=d.length?(++f,--g):6<d.length&&(f+=2,g-=2);let h=0;for(let b=f;b<g;++b)h+=d[b];if(this._latency=h/(g-f),d.length=0,!this._domHandler.IsHost()){const b=a.indexOf("/");if(-1<b){const d=parseFloat(a.substr(b+1));isFinite(d)?this._domHandler.AddHostTime(d,c,e,this._latency):console.warn("Invalid host time from pong response")}else console.warn("Cannot parse off host time from pong response")}}_OnMessage(a,b){const c=this._domHandler.GetSimulatedPacketLoss(),d=this._domHandler.GetSimulatedLatency(),e=this._domHandler.GetSimulatedPdv();if(!(0<c&&"u"===a&&Math.random()<c))if(0===d&&0===e)this._DoOnMessage(a,b);else{let f=1;"u"!==a&&Math.random()<c&&(f=3),setTimeout(()=>this._DoOnMessage(a,b),d*f+Math.random()*e*f)}}_DoOnMessage(a,b){if(this._wasRemoved)return;this._lastHeardFrom=performance.now(),this._domHandler.StatIncInboundCount();let c=0;if(b.data.length?c=b.data.length:b.data.byteLength&&(c=b.data.byteLength),this._domHandler.StatAddInboundBandwidthCount(c),"string"==typeof b.data){if(""===b.data.trim()||4>b.data.length)return;const a=b.data.substr(0,4);if("ping"===a)return void this.SendPong(b.data);if("pong"===a)return void this._OnPong(b.data);var d;try{d=JSON.parse(b.data)}catch(a){return this._domHandler._OnPeerError(this,a),this._domHandler.IsHost()?(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",a),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",a),void console.log("String that failed to parse from previous error: "+b.data)}if(!d)return;try{d["c"]&&"m"!==d["c"]?this._OnControlMessage(d):this._domHandler._OnPeerMessage(this,d)}catch(a){this._domHandler._OnPeerError(this,a),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",a),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",a)}return}!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===a&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{this._OnBinaryMessage(b.data)}catch(a){return this._domHandler._OnPeerError(this,a),void(this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",a),this.Remove("data error")):console.error("Error handling binary update for peer '"+this._id+"': ",a))}}_OnControlMessage(a){let b,c;switch(a["c"]){case"disconnect":a["k"]&&this._domHandler.PostToRuntime("peer-kicked"),c=!this._domHandler.IsHost()&&!this.IsHost(),this.Remove(a["r"]),c&&this._domHandler.SignallingLeaveRoom();break;case"hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(a["hn"]),this._domHandler.GetSelfPeer()._SetNid(a["n"]),this._domHandler.SetClientDelay(a["d"]),this._domHandler.SetPeerUpdateRateSec(a["u"]),this._domHandler.MapObjectNids(a["objs"]),this._domHandler.MapClientValues(a["cvs"]));break;case"j":this._domHandler.IsHost()||(b=new e(this._domHandler,a["i"],a["a"]),b._SetNid(a["n"]),this._domHandler._OnPeerOpen(b));break;case"l":this._domHandler.IsHost()||(b=this._domHandler.GetPeerById(a["i"]),b&&(!b.IsSelf()&&this._domHandler._OnPeerClose(b,a["r"]),b.Remove(a["r"])));break;default:console.error("Unknown control message from peer '"+this._id+"': "+a["c"]),this._domHandler._OnPeerError(this,"unknown control message '"+a["c"]+"'");}}_OnBinaryMessage(a){this._domHandler.IsHost()?this._OnHostUpdate(a):this._OnPeerUpdate(a)}_OnHostUpdate(a){const b=new DataView(a);let c=0;const d=b.getUint32(c);if(c+=4,1664249200!==d)return void console.warn("Rejected packet with incorrect magic number (received '"+d+"', expected '"+1664249200+"'");let e=b.getFloat64(c);if(c+=8,e+=this._latency,!(3e3<=Math.abs(e-performance.now()))){b.getUint8(c);c+=1;const a=b.getUint8(c);c+=1;const d=[],f=this._domHandler.GetClientValues();for(let e=0;e<a;++e){if(e>=f.length){d.push(0);continue}const a=f[e];let g=0;switch(a.GetPrecision()){case 0:g=b.getFloat64(c),c+=8;break;case 1:g=b.getFloat32(c),c+=4;break;case 2:g=a.MaybeUnpack(b.getInt16(c)),c+=2;break;case 3:g=a.MaybeUnpack(b.getUint8(c)),c+=1;break;default:g=b.getFloat32(c),c+=4;}d.push(g)}this._AddClientUpdate(e,d)}}_AddClientUpdate(a,b){for(let c=0,d=this._clientStateUpdates.length;c<d;++c){const d=this._clientStateUpdates[c];if(d.timestamp===a)return;if(d.timestamp>a)return void this._clientStateUpdates.splice(c,0,new C3NetUpdate(a,b))}this._clientStateUpdates.push(new C3NetUpdate(a,b))}Tick(a){if(0!==this._clientStateUpdates.length){for(;2<this._clientStateUpdates.length&&this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();if(!(this._nextUpdate&&this._nextUpdate.timestamp>a&&this._priorUpdate&&this._priorUpdate.timestamp<a)){this._nextUpdate=null;for(let b=0,c=this._clientStateUpdates.length;b<c;++b){const c=this._clientStateUpdates[b];if(c.timestamp<=a)(!this._priorUpdate||c.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=c);else{this._nextUpdate=c;break}}}}}_OnPeerUpdate(a){const b=new DataView(a);let c=0;const d=b.getUint32(c);if(c+=4,1664249200!==d)return void console.warn("Rejected packet with incorrect magic number (received '"+d+"', expected '"+1664249200+"'");const e=b.getUint32(c);c+=4,0===e?this._HandlePeerUpdate(b,c):1===e?this._HandlePeerEvents(b,c):console.warn("Ignoring packet with incorrect flags (received "+e+", expected 0 or 1")}_HandlePeerUpdate(a,b){const c=a.getFloat64(b);b+=8;const d=a.getUint16(b);b+=2;for(let e=0;e<d;++e){const d=a.getUint16(b);b+=2;const e=a.getUint8(b);b+=1;let f=null,g=0;const h=this._domHandler.GetRegisteredObjectByNid(d);h?(f=h.GetNetValues(),g=f.length,1===e&&h._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+d);const i=a.getUint16(b);b+=2;const j=a.getUint16(b);b+=2;for(let d=0;d<i;++d){const d=a.getUint16(b);if(b+=2,h){const e=[];let i=b;for(let b=0;b<g;++b){const c=f[b];let d=0;switch(c.GetPrecision()){case 0:d=a.getFloat64(i),i+=8;break;case 1:d=a.getFloat32(i),i+=4;break;case 2:d=c.MaybeUnpack(a.getInt16(i)),i+=2;break;case 3:d=c.MaybeUnpack(a.getUint8(i)),i+=1;break;default:d=a.getFloat32(i),i+=4;}e.push(d)}h.AddUpdate(c,d,e)}b+=j}}}_HandlePeerEvents(a,b){const c=a.getFloat64(b);b+=8;const d=a.getUint16(b);b+=2;for(let e=0;e<d;++e){const d=a.getUint16(b);b+=2;const e=this._domHandler.GetRegisteredObjectByNid(d);e||console.warn("Don't know which object corresponds to NID "+ro_nid);const f=a.getUint16(b);b+=2;for(let d=0;d<f;++d){const d=a.getUint16(b);b+=2,e&&!e.HasOverriddenNids()&&(this._domHandler._OnInstanceDestroyed(e,d,c),e.RemoveObjectNid(d))}}}Remove(b,c){this._wasRemoved||(this._wasRemoved=!0,this._MaybeFireClose(b),this.Send("o",JSON.stringify({"c":"disconnect","r":b,"k":!!c})),a(this._dco),a(this._dcr),a(this._dcu),a(this._pc),this._dco=null,this._dcr=null,this._dcu=null,this._pc=null,this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._domHandler._RemovePeer(this))}HasClientState(a){return this._domHandler.HasClientValueTag(a)}GetClientState(a){const b=this._domHandler.GetClientValueByTag(a);if(!b)return 0;const c=b.GetIndex();if(0===this._clientStateUpdates.length)return 0;const d=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return 0>c||c>=d.length?0:d[c]}GetInterpClientState(a){const c=a.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){const a=this._nextUpdate.data;return 0>c||c>=a.length?0:a[c]}const d=this._domHandler.GetSimulationTime();let e,f,g,h,i;if(!this._nextUpdate&&this._priorUpdate)if(this._priorUpdate2){e=this._priorUpdate2.timestamp,f=this._priorUpdate2.data[c],g=this._priorUpdate.timestamp,h=this._priorUpdate.data[c];let a=d;return a>this._priorUpdate.timestamp+250&&(a=this._priorUpdate.timestamp+250),i=b(e,g,a),C3NetValue.InterpNetValue(this._domHandler.GetClientValues()[c].GetInterp(),f,h,i,!0)}else{const a=this._priorUpdate.data;return 0>c||c>=a.length?0:a[c]}return e=this._priorUpdate.timestamp,f=this._priorUpdate.data[c],g=this._nextUpdate.timestamp,h=this._nextUpdate.data[c],i=b(e,g,d),C3NetValue.InterpNetValue(this._domHandler.GetClientValues()[c].GetInterp(),f,h,i,!1)}}self.C3Peer=e}"use strict";{const a=window["RTCPeerConnection"]||window["webkitRTCPeerConnection"]||window["mozRTCPeerConnection"]||window["msRTCPeerConnection"],b=window["RTCSessionDescription"]||window["webkitRTCSessionDescription"]||window["mozRTCSessionDescription"]||window["msRTCSessionDescription"],c=window["RTCIceCandidate"]||window["webkitRTCIceCandidate"]||window["mozRTCIceCandidate"]||window["msRTCIceCandidate"],d=window["RTCDataChannel"]||window["webkitRTCDataChannel"]||window["mozRTCDataChannel"]||window["msRTCDataChannel"],e=[{"urls":"stun:stun.l.google.com:19302"}];let f=!1;const g=[],h=class extends DOMHandler{constructor(a){super(a,"multiplayer"),this._iceServers=[],this._sigWs=null,this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""},this._myId="",this._myAlias="",this._game="",this._gameInstance="",this._room="",this._allPeers=[],this._peersById=new Map,this._nextPeerNid=0,this._usedPeerNids=new Set,this._selfPeer=null,this._hostPeer=null,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._lastUpdateTime=0,this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundBandwidthCount:0},this._dataBuffer=new ArrayBuffer(262144),this._dataView=new DataView(this._dataBuffer),this._allRegisteredObjects=[],this._nextObjectNid=1,this._registeredObjectsByNid=new Map,this._registeredObjectsByRoId=new Map,this._simLatency=0,this._simPdv=0,this._simPacketLoss=0,this._lastTimeDiffs=[],this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._allClientValues=[],this._clientValuesByTag=new Map,this._receivedClientValues=!1,this._MergeICEServerList(e),setInterval(()=>this._DoPings(),2e3),window.addEventListener("unload",()=>this.RemoveAllPeers("quit")),this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported()),this.AddRuntimeMessageHandler("add-ice-servers",(a)=>this._MergeICEServerList(a["list"])),this.AddRuntimeMessageHandler("simulate-latency",(a)=>this.SetLatencySimulation(a["latency"],a["pdv"],a["loss"])),this.AddRuntimeMessageHandler("set-bandwidth-profile",(a)=>this.SetBandwidthSettings(a["updateRate"],a["delay"])),this.AddRuntimeMessageHandler("tick",(a)=>this.Tick(a)),this.AddRuntimeMessageHandler("alert",(a)=>this.Alert(a)),this.AddRuntimeMessageHandler("signalling-connect",(a)=>this.SignallingConnect(a["url"])),this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect()),this.AddRuntimeMessageHandler("signalling-login",(a)=>this.SignallingLogin(a["alias"])),this.AddRuntimeMessageHandler("signalling-join-room",(a)=>this.SignallingJoinGameRoom(a["game"],a["instance"],a["room"],a["maxClients"])),this.AddRuntimeMessageHandler("signalling-auto-join-room",(a)=>this.SignallingAutoJoinGameRoom(a["game"],a["instance"],a["room"],a["maxClients"],a["lock"])),this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom()),this.AddRuntimeMessageHandler("signalling-list-game-instances",(a)=>this.SignallingRequestGameInstanceList(a["game"])),this.AddRuntimeMessageHandler("signalling-list-rooms",(a)=>this.SignallingRequestRoomList(a["game"],a["instance"],a["which"])),this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0)),this.AddRuntimeMessageHandler("peer-send-message",(a)=>this.OnPeerSendMessage(a)),this.AddRuntimeMessageHandler("host-broadcast",(a)=>this.OnHostBroadcast(a)),this.AddRuntimeMessageHandler("kick-peer",(a)=>this.OnKickPeer(a)),this.AddRuntimeMessageHandler("sync-object",(a)=>this.OnSyncObject(a)),this.AddRuntimeMessageHandler("sync-inst-var",(a)=>this.OnSyncInstVar(a)),this.AddRuntimeMessageHandler("associate-object",(a)=>this.OnAssociateObject(a)),this.AddRuntimeMessageHandler("remove-object-id",(a)=>this.RemoveObjectId(a["uid"])),this.AddRuntimeMessageHandler("remove-net-insts",(a)=>this.OnRemoveNetInsts(a)),this.AddRuntimeMessageHandler("remove-object-nid",(a)=>this.OnRemoveObjectNid(a)),this.AddRuntimeMessageHandler("set-client-state",(a)=>this.SetClientState(a["tag"],a["value"])),this.AddRuntimeMessageHandler("add-client-input-value",(a)=>this.AddClientInputValue(a["tag"],a["precision"],a["interp"]))}_GetErrorMessage(a){return a?"string"==typeof a?a:"string"==typeof a["message"]?a["message"]:"string"==typeof a["details"]?a["details"]:"string"==typeof a["data"]?a["data"]:"string"==typeof a["type"]?a["type"]:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return this.IsLoggedIn()&&this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this.IsLoggedIn()?this._myId:""}GetMyAlias(){return this.IsLoggedIn()?this._myAlias:""}GetCurrentGame(){return this.IsLoggedIn()?this._game:""}GetCurrentGameInstance(){return this.IsLoggedIn()?this._gameInstance:""}GetCurrentRoom(){return this.IsInRoom()?this._room:""}GetHostId(){return this._hostPeer?this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(a,b,c){var d=Math.max;this._simLatency=d(a,0),this._simPdv=d(b,0),this._simPacketLoss=d(c,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{"isSupported":!!(a&&d)}}SignallingConnect(a){if(!(this._sigWs||this._isSignallingConnected)){try{this._sigWs=new WebSocket(a,"c2multiplayer")}catch(a){return this._sigWs=null,void this._OnSignallingError(a)}this._sigWs.onopen=()=>-1===this._sigWs.protocol.indexOf("c2multiplayer")?(this._OnSignallingError("server does not support 'c2multiplayer' protocol"),this._sigWs.close(1002,"'c2multiplayer' protocol required"),this._sigWs=null,void(this._isSignallingConnected=!1)):void(this._isSignallingConnected=!0),this._sigWs.onclose=()=>{this._OnSignallingClose(),this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigWs=null},this._sigWs.onerror=(a)=>{console.error("Signalling server error: ",a),this._OnSignallingError(a)},this._sigWs.onmessage=(a)=>{this._OnSignallingMessage(a)}}}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(a){let b;try{b=JSON.parse(a.data)}catch(a){return void this._OnSignallingError(a)}switch(b["message"]){case"welcome":this._OnSignallingReceiveWelcome(b);break;case"login-ok":this._OnSignallingReceiveLoginOK(b);break;case"join-ok":this._OnSignallingReceiveJoinOK(b);break;case"leave-ok":this._OnSignallingReceiveLeaveOK(b);break;case"kicked":this._OnSignallingReceiveKicked(b);break;case"peer-joined":this._OnSignallingReceivePeerJoined(b);break;case"peer-quit":this._OnSignallingReceivePeerQuit(b);break;case"icecandidate":this._OnSignallingReceiveIceCandidate(b);break;case"offer":this._OnSignallingReceiveOffer(b);break;case"answer":this._OnSignallingReceiveAnswer(b);break;case"instance-list":this._OnSignallingReceiveInstanceList(b);break;case"room-list":this._OnSignallingReceiveRoomList(b);break;case"error":this._OnSignallingError(b["details"]);break;default:this._OnSignallingError("received unknown signalling message");}}HasICEServerUrl(a){for(const b of this._iceServers)if(b["urls"]===a["urls"])return!0;return!1}_MergeICEServerList(a){if(a)for(let b of a)"string"==typeof b&&(b={"urls":b}),this.HasICEServerUrl(b)||(!b.hasOwnProperty("url")&&(b["url"]=b["urls"]),this._iceServers.push(b))}GetICEServerList(){return this._iceServers}_OnSignallingError(a){this.PostToRuntime("signalling-error",{"message":this._GetErrorMessage(a)})}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(a){if(1>a["protocolrev"]||1<a["protocolrev"])return this._OnSignallingError("signalling server protocol revision not supported"),void this.SignallingDisconnect();this._myId=a["clientid"];const b=this._sigservInfo;b.protocolrev=a["protocolrev"],b.version=a["version"],b.name=a["name"],b.operator=a["operator"],b.motd=a["motd"],this._MergeICEServerList(a["ice_servers"]),this.PostToRuntime("signalling-welcome",{"myid":this._myId,"sigservinfo":{"protocolrev":b.protocolrev,"version":b.version,"name":b.name,"operator":b.operator,"motd":b.motd}})}_OnSignallingReceiveLoginOK(a){this._myAlias=a["alias"],this._isSignallingLoggedIn=!0,this.PostToRuntime("signalling-login-ok",{"myalias":this._myAlias})}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(this.IsHost()){do this._nextPeerNid++,65535<this._nextPeerNid&&(this._nextPeerNid=0);while(this._usedPeerNids.has(this._nextPeerNid));const a=this._nextPeerNid;return this._usedPeerNids.add(a),a}}FreePeerNid(a){this.IsHost()&&this._usedPeerNids.delete(a)}_OnSignallingReceiveJoinOK(a){this.RemoveAllPeers("disconnect"),this._game=a["game"],this._gameInstance=a["instance"],this._room=a["room"],this._selfPeer=new C3Peer(this,this._myId,this._myAlias),a["host"]?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):(this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._hostPeer=new C3Peer(this,a["hostid"],a["hostalias"]),this._hostPeer.Connect()),this.PostToRuntime("signalling-join-ok",{"isHost":!!a["host"],"hostId":this._hostPeer.GetId(),"hostAlias":this._hostPeer.GetAlias(),"game":this._game,"gameInstance":this._gameInstance,"room":this._room})}_OnSignallingReceiveLeaveOK(){this._room="",this.PostToRuntime("signalling-leave-ok")}_OnSignallingReceiveKicked(){this.DisconnectRoom(),this._room="",this.PostToRuntime("signalling-kicked")}_OnSignallingReceivePeerJoined(a){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const b=this._peersById.get(a["peerid"]);b&&b.Remove("rejoin");const c=new C3Peer(this,a["peerid"],a["peeralias"]);c.Connect()}}_OnSignallingReceivePeerQuit(a){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const b=this._peersById.get(a["id"]);b&&b.Remove(a["reason"])}}_OnSignallingReceiveIceCandidate(a){if(this._isSignallingLoggedIn&&this._room){const b=this._peersById.get(a["from"]);b&&b._AddICECandidate(new c(a["icecandidate"]))}}_OnSignallingReceiveOffer(a){if(!this._isSignallingLoggedIn||!this._room||this.IsHost()||!this._selfPeer||!this._hostPeer||!this._hostPeer.HasPeerConnection())return;if(a["from"]!==this._hostPeer.GetId())return;const c=this._hostPeer.GetPeerConnection();c.setRemoteDescription(new b(a["offer"])).then(()=>{c.createAnswer().then((a)=>{c.setLocalDescription(a),this.SignallingSend({"message":"answer","toclientid":this._hostPeer.GetId(),"answer":a})}).catch((a)=>{console.error("Peer error creating answer: ",a),this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch((a)=>{console.error("Peer error setting remote description: ",a),this._OnPeerError(this._selfPeer,"could not set remote description")})}_OnSignallingReceiveAnswer(a){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const c=this._peersById.get(a["from"]);c&&c.GetPeerConnection().setRemoteDescription(new b(a["answer"])).catch((a)=>{console.error("Host error setting remote description: ",a)})}}_OnSignallingReceiveInstanceList(a){this.PostToRuntime("signalling-instance-list",{"list":a["list"]})}_OnSignallingReceiveRoomList(a){this.PostToRuntime("signalling-room-list",{"list":a["list"]})}SignallingSend(a){this._sigWs&&this._isSignallingConnected&&this._sigWs.send(JSON.stringify(a))}SignallingLogin(a){this._isSignallingLoggedIn||this.SignallingSend({"message":"login","protocolrev":1,"alias":a})}SignallingJoinGameRoom(a,b,c,d){!this._isSignallingLoggedIn||this._room||this.SignallingSend({"message":"join","game":a,"instance":b,"room":c,"max_clients":d})}SignallingAutoJoinGameRoom(a,b,c,d,e){!this._isSignallingLoggedIn||this._room||this.SignallingSend({"message":"auto-join","game":a,"instance":b,"room":c,"max_clients":d,"lock_when_full":e})}SignallingLeaveRoom(){this._isSignallingLoggedIn&&this.SignallingSend({"message":"leave"})}SignallingConfirmPeer(a){this._isSignallingLoggedIn&&this.IsHost()&&this.SignallingSend({"message":"confirm-peer","id":a})}SignallingRequestGameInstanceList(a){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({"message":"list-instances","game":a})}SignallingRequestRoomList(a,b,c){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({"message":"list-rooms","game":a,"instance":b,"which":c})}DisconnectRoom(a){this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this.RemoveAllPeers("disconnect"),a&&this.SignallingLeaveRoom()}_AddPeer(a){this._allPeers.push(a),this._peersById.set(a.GetId(),a),this.PostToRuntime("add-peer",{"id":a.GetId(),"alias":a.GetAlias()})}_RemovePeer(a){this.PostToRuntime("remove-peer",{"id":a.GetId()}),this.IsHost()&&this.FreePeerNid(a.GetNid());const b=this._allPeers.indexOf(a);-1<b&&this._allPeers.splice(b,1),this._peersById.delete(a.GetId()),this._hostPeer===a&&(this._hostPeer=null,this.RemoveAllPeers("host quit")),this._selfPeer===a&&(this._selfPeer=null,this._room="",this.RemoveAllPeers("disconnect"))}RemoveAllPeers(a){if(!f){for(f=!0;this._allPeers.length;)this._allPeers[0].Remove(a);f=!1}}GetPeerById(a){return this._peersById.get(a)||null}GetAliasFromId(a){const b=this._peersById.get(a);return b?b.GetAlias():""}GetPeerByNid(a){for(const b of this._allPeers)if(b.GetNid()===a)return b;return null}OnHostBroadcast(a){const b=a["fromId"],c=a["tag"],d=a["message"],e=a["mode"],f=this.GetPeerById(b);this.HostBroadcast(e,JSON.stringify({"c":"m","t":c,"f":b,"m":d}),f)}HostBroadcast(a,b,c){if(this.IsHost()){const d=this._allPeers.slice(0);for(const e of d)e&&e!==this._selfPeer&&e!==c&&e.Send(a,b)}}_DoPings(){const a=performance.now();if(this.IsHost()){g.push(...this._allPeers);for(const b of g)b&&b!==this._selfPeer&&b.SendPing(a,!1);g.length=0}else this._hostPeer&&this._hostPeer.SendPing(a,!1)}AddRegisteredObject(a){this._allRegisteredObjects.push(a),this._registeredObjectsByRoId.set(a.GetRoId(),a),this._registeredObjectsByNid.set(a.GetNid(),a)}GetRegisteredObjectsMap(){const a={};for(const[b,c]of this._registeredObjectsByNid.entries())a[c.GetSid()]={"nid":b,"nvs":c.GetNetValuesJson()};return a}MapObjectNids(a){this._registeredObjectsByNid.clear();for(const b of this._allRegisteredObjects)if(a.hasOwnProperty(b.GetSid().toString())){const c=a[b.GetSid().toString()];b._SetNid(c["nid"]),this._registeredObjectsByNid.set(c["nid"],b),b.SetNetValuesFrom(c["nvs"])}else console.warn("Could not map object SID '"+b.GetSid()+"' - host did not send NID for it"),b._SetNid(-1)}GetRegisteredObjectByNid(a){return this._registeredObjectsByNid.get(a)||null}Tick(a){if(!this.IsInRoom())return null;const b=a["dt"],c=performance.now(),d=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec;c-this._lastUpdateTime>=1e3/d-5&&(this.SendUpdate(c),this._lastUpdateTime=c);const e=this._stats;1e3<=c-e.lastSecondTime&&(e.outboundPerSec=e.outboundCount,e.outboundBandwidthPerSec=e.outboundBandwidthCount,e.inboundPerSec=e.inboundCount,e.inboundBandwidthPerSec=e.inboundBandwidthCount,e.outboundCount=0,e.outboundBandwidthCount=0,e.inboundCount=0,e.inboundBandwidthCount=0,e.lastSecondTime+=1e3,500<c-e.lastSecondTime&&(e.lastSecondTime=c),this.PostToRuntime("stats",{"stats":{"outboundPerSec":e.outboundPerSec,"outboundBandwidthPerSec":e.outboundBandwidthPerSec,"inboundPerSec":e.inboundPerSec,"inboundBandwidthPerSec":e.inboundBandwidthPerSec}})),this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*b,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*b,this._hostTimeDiff<this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)),this._simDelay<this._targetSimDelay?(this._simDelay+=30*b,this._simDelay>this._targetSimDelay&&(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*b,this._simDelay<this._targetSimDelay&&(this._simDelay=this._targetSimDelay)));const f=this.GetSimulationTime();for(const b of this._allPeers)b.Tick(f);for(const b of this._allRegisteredObjects)b.Tick();return{"simulationTime":this.GetSimulationTime(),"hostInputArrivalTime":this.GetHostInputArrivalTime(),"clientDelay":this._clientDelay,"peerData":this._GetPeerRuntimeData(),"roData":this._GetRegisteredObjectRuntimeData(),"isReadyForInput":this.IsReadyForInput()}}_GetPeerRuntimeData(){const a={};for(const b of this._allPeers){const c={};for(const a of this._allClientValues)c[a.GetTag()]=b.GetInterpClientState(a);a[b.GetId()]={"nid":b.GetNid(),"latency":b.GetLatency(),"pdv":b.GetPdv(),"clientState":c}}return a}_GetRegisteredObjectRuntimeData(){const a={};for(const b of this._allRegisteredObjects)a[b.GetRoId()]=b.GetRuntimeData();return a}async SendUpdate(a){this.IsHost()?(await this._SendHostUpdate(a),this._SendHostEvents(a)):await this._SendClientUpdate(a)}async _OnBeforeClientUpdate(){const a=await this.PostToRuntimeAsync("before-client-update");for(const b of a["clientStateUpdates"])this.SetClientState(b["tag"],b["value"])}async _SendClientUpdate(a){if(this.IsReadyForInput()&&(await this._OnBeforeClientUpdate()),!this._selfPeer||!this._receivedClientValues)return;const b=this._dataView;let c=0;const d=this._allClientValues,e=this._selfPeer.GetLocalClientState(),f=a-this._selfPeer.GetLastStateChange(),g=a-this._selfPeer.GetLastStateTransmit();let h=!1;if(h=!!(100>f)||(1e3>f?95<=g:495<=g),!!h){b.setUint32(c,1664249200),c+=4,b.setFloat64(c,a+this._hostTimeDiff),c+=8,b.setUint8(c,0),c+=1,b.setUint8(c,d.length),c+=1;for(let a=0,f=d.length;a<f;++a){const f=d[a];let g=0;a<e.length&&(g=f.Clamp(e[a])),c=f.Write(b,c,g)}this._selfPeer._SetLastStateTransmit(a),this._hostPeer.Send("u",new Uint8Array(this._dataBuffer,0,c))}}async _SendHostUpdate(a){const b=this._dataView;let c=0,d=0;const e=await this.PostToRuntimeAsync("get-object-info",{"ros":this._allRegisteredObjects.map((a)=>a.GetRuntimeInfoRequest())});for(const b of this._allRegisteredObjects){const c=b.GetRoId();if(!e.hasOwnProperty(c))continue;const f=e[c];b.UpdateData(f,a),0<b.GetNumberToTransmit()&&d++}if(0!=d){b.setUint32(c,1664249200),c+=4,b.setUint32(c,0),c+=4,b.setFloat64(c,a),c+=8,b.setUint16(c,d),c+=2;for(const d of this._allRegisteredObjects)0<d.GetNumberToTransmit()&&(c=d.WriteData(b,c,a));this.HostBroadcast("u",new Uint8Array(this._dataBuffer,0,c),null)}}_SendHostEvents(a){const b=this._dataView;let c=0,d=0;for(const b of this._allRegisteredObjects)b.GetDeadNids().length&&d++;if(0!=d){b.setUint32(c,1664249200),c+=4,b.setUint32(c,1),c+=4,b.setFloat64(c,a),c+=8,b.setUint16(c,d),c+=2;for(const a of this._allRegisteredObjects){const d=a.GetDeadNids();if(d.length){b.setUint16(c,a.GetNid()),c+=2,b.setUint16(c,d.length),c+=2;for(const a of d)b.setUint16(c,a),c+=2;d.length=0}}this.HostBroadcast("r",new Uint8Array(this._dataBuffer,0,c),null)}}AddHostTime(a,b,c,d){if(this.IsHost())return;this._targetSimDelay=d+this._clientDelay;var e=a+c-b;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=e,this._simDelay=this._targetSimDelay),this._lastTimeDiffs.push(e),30<this._lastTimeDiffs.length&&this._lastTimeDiffs.shift(),g.push(...this._lastTimeDiffs),g.sort((c,a)=>c-a);let f=0,h=g.length;4<=g.length&&6>=g.length?(++f,--h):6<g.length&&19>=g.length?(f+=2,h-=2):19<g.length&&(f+=5,h-=5);let j=0;for(let e=f;e<h;++e)j+=g[e];this._targetHostTimeDiff=j/(h-f),g.length=0}GetSimulationTime(){return this.IsHost()?performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(a,b){if(!this.IsHost()&&this._selfPeer&&this._receivedClientValues){const c=this._clientValuesByTag.get(a);if(c){const a=c.GetIndex(),d=this._selfPeer.GetLocalClientState();d.length<a+1&&(d.length=a+1),d[a]!==b&&(d[a]=b,this._selfPeer._SetLastStateChange(performance.now()))}}}AddClientInputValue(a,b,c){const d=new C3NetValue(this._allClientValues.length,c,b,a,null);this._clientValuesByTag.set(a,d),this._allClientValues.push(d)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const a=[];for(const b of this._allClientValues)a.push({"tag":b.GetTag(),"precision":b.GetPrecision(),"interp":b.GetInterp()});return a}MapClientValues(a){this._clientValuesByTag.clear(),this._allClientValues.length=0;for(let b=0,c=a.length;b<c;++b){const c=a[b],d=new C3NetValue(b,c["interp"],c["precision"],c["tag"],null);this._clientValuesByTag.set(d.GetTag(),d),this._allClientValues.push(d)}this._receivedClientValues=!0}RemoveObjectId(a){for(const b of this._allRegisteredObjects)b.RemoveObjectId(a)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(a){return a=Math.floor(a),!this.IsInRoom()||0>a||a>=this._allPeers.length?null:this._allPeers[a]}IsReadyForInput(){return!!this.IsInRoom()&&(!!this.IsHost()||0!==this._targetHostTimeDiff)}SetBandwidthSettings(a,b){this.IsInRoom()||(this._hostUpdateRateSec=a,this._peerUpdateRateSec=a,this._clientDelay=b)}_OnPeerOpen(a){this.PostToRuntime("peer-open",{"id":a.GetId(),"alias":a.GetAlias()})}OnPeerSendMessage(a){const b=a["id"],c=a["tag"],d=a["message"],e=a["mode"],f=this.GetPeerById(b);f&&f.Send(e,JSON.stringify({"c":"m","t":c,"m":d}))}_OnPeerClose(a,b){this.PostToRuntime("peer-close",{"id":a.GetId(),"alias":a.GetAlias(),"reason":b||"unknown"})}_OnPeerError(a,b){console.error(`[Multiplayer] Peer '${a.GetAlias()}' (${a.GetId()}) error: `,b)}_OnPeerMessage(a,b){const c=b["f"]||a.GetId();this.PostToRuntime("peer-message",{"tag":b["t"],"fromId":c,"fromAlias":this.GetAliasFromId(c),"content":b["m"]})}_OnInstanceDestroyed(a,b,c){this.PostToRuntime("instance-destroyed",{"roId":a.GetRoId(),"nid":b,"timestamp":c})}OnKickPeer(a){if(this.IsHost()){const b=a["id"],c=a["reason"],d=this.GetPeerById(b);d&&d.Remove(c,!0)}}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(a){this._stats.outboundBandwidthCount+=a}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(a){this._stats.inboundBandwidthCount+=a}SetClientDelay(a){this._clientDelay=a}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(a){this._peerUpdateRateSec=a}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(a){const b=a["data"],c=a["precision"],d=a["bandwidth"];for(const e of a["objectClasses"]){const a=new C3RegisteredObject(this,e["roId"],e["sid"],d);1===b?(a.AddValue(1,c,"x"),a.AddValue(1,c,"y")):2===b?a.AddValue(2,c,"a"):3===b&&(a.AddValue(1,c,"x"),a.AddValue(1,c,"y"),a.AddValue(2,c,"a"))}}Alert(a){alert(a["message"])}OnSyncInstVar(a){const b=a["precision"],c=a["interp"],d=a["cvt"];for(const e of a["syncData"]){const a=this._registeredObjectsByRoId.get(e["roId"]);a.AddValue(c,b,"iv",e["varIndex"],d)}}OnAssociateObject(a){const b=a["roId"],c=a["peerId"],d=a["instUid"],e=this._registeredObjectsByRoId.get(b),f=this._peersById.get(c);e&&f&&(!this.IsHost()||e.OverrideNid(d,f.GetNid()))}OnRemoveNetInsts(a){for(const[b,c]of Object.entries(a)){const a=this._registeredObjectsByRoId.get(parseInt(b,10));if(a)for(const b of c)a.RemoveObjectNid(b)}}OnRemoveObjectNid(a){const b=a["roId"],c=a["nid"],d=this._registeredObjectsByRoId.get(b);d&&d.RemoveObjectNid(c)}};RuntimeInterface.AddDOMHandlerClass(h)}"use strict";{function a(){const a=self["RealFile"]||self["File"];return"function"==typeof navigator["canShare"]&&navigator["canShare"]({"files":[new a(["test file"],"test.txt",{})]})}const b=class extends DOMHandler{constructor(b){super(b,"share");const c=!!this._GetCordovaPlugin();this._isWebShareSupported="function"==typeof navigator["share"],this._isSupported=this._isWebShareSupported||c,this._isWebShareFilesSupported=a(),this._isFilesSupported=this._isWebShareFilesSupported||c,this.AddRuntimeMessageHandlers([["init",(a)=>this._OnInit(a)],["share",(a)=>this._OnShare(a)]])}_OnInit(){return{"isSupported":this._isSupported,"isFilesSupported":this._isFilesSupported}}_GetCordovaPlugin(){return window["plugins"]&&window["plugins"]["socialsharing"]}async _OnShare(a){const b=a["text"],c=a["title"],d=a["url"],e=a["files"].slice(0),f=0<e.length,g=this._GetCordovaPlugin();if(!g){const a={};b&&(a["text"]=b),c&&(a["title"]=c),d&&(a["url"]=d),f&&(a["files"]=e);try{await navigator["share"](a),this.PostToRuntime("share-completed")}catch(a){console.log("[Share plugin] Share failed: ",a),this.PostToRuntime("share-failed")}}else{const a={};if(b&&(a["message"]=b),c&&(a["subject"]=c),d&&(a["url"]=d),f){let b=0;for(const a of e)b+=a.size;try{const c=await this._CordovaGetTempDirEntry(Math.floor(1.25*b));a["files"]=await Promise.all(e.map((a)=>this._CordovaWriteTempFile(a,c)))}catch(a){return console.log("[Share plugin] Share failed: ",a),void this.PostToRuntime("share-failed")}}g["shareWithOptions"](a,()=>{this.PostToRuntime("share-completed")},(a)=>{console.log("[Share plugin] Share failed: ",a),this.PostToRuntime("share-failed")})}}_CordovaGetTempDirEntry(a){return new Promise((b,c)=>{window["requestFileSystem"](window["TEMPORARY"],a,(a)=>b(a["root"]),c)})}_CordovaWriteTempFile(a,b){return new Promise((c,d)=>{b["getFile"](a.name,{"create":!0,"exclusive":!1},(b)=>{const e=b["toURL"]();b["createWriter"]((b)=>{b["onwriteend"]=()=>c(e),b["onerror"]=d,b["write"](a)})},d)})}};RuntimeInterface.AddDOMHandlerClass(b)}"use strict";{const a=class extends DOMHandler{constructor(a){super(a,"browser"),this._exportType="",this.AddRuntimeMessageHandler("get-initial-state",(a)=>this._OnGetInitialState(a)),this.AddRuntimeMessageHandler("ready-for-sw-messages",()=>this._OnReadyForSWMessages()),this.AddRuntimeMessageHandler("alert",(a)=>this._OnAlert(a)),this.AddRuntimeMessageHandler("close",()=>this._OnClose()),this.AddRuntimeMessageHandler("set-focus",(a)=>this._OnSetFocus(a)),this.AddRuntimeMessageHandler("vibrate",(a)=>this._OnVibrate(a)),this.AddRuntimeMessageHandler("lock-orientation",(a)=>this._OnLockOrientation(a)),this.AddRuntimeMessageHandler("unlock-orientation",()=>this._OnUnlockOrientation()),this.AddRuntimeMessageHandler("navigate",(a)=>this._OnNavigate(a)),this.AddRuntimeMessageHandler("request-fullscreen",(a)=>this._OnRequestFullscreen(a)),this.AddRuntimeMessageHandler("exit-fullscreen",()=>this._OnExitFullscreen()),window.addEventListener("online",()=>this._OnOnlineStateChanged(!0)),window.addEventListener("offline",()=>this._OnOnlineStateChanged(!1)),document.addEventListener("backbutton",()=>this._OnCordovaBackButton()),"undefined"!=typeof Windows&&Windows["UI"]["Core"]["SystemNavigationManager"]["getForCurrentView"]().addEventListener("backrequested",(a)=>this._OnWin10BackRequested(a))}_OnGetInitialState(a){return this._exportType=a["exportType"],{"location":location.toString(),"isOnline":!!navigator.onLine,"referrer":document.referrer,"title":document.title,"isCookieEnabled":!!navigator.cookieEnabled,"screenWidth":screen.width,"screenHeight":screen.height,"windowOuterWidth":window.outerWidth,"windowOuterHeight":window.outerHeight,"isScirraArcade":"undefined"!=typeof window["is_scirra_arcade"]}}_OnReadyForSWMessages(){window["C3_RegisterSW"]&&window["OfflineClientInfo"]&&window["OfflineClientInfo"]["SetMessageCallback"]((a)=>this.PostToRuntime("sw-message",a["data"]))}_OnOnlineStateChanged(a){this.PostToRuntime("online-state",{"isOnline":a})}_OnCordovaBackButton(){this.PostToRuntime("backbutton")}_OnWin10BackRequested(a){a["handled"]=!0,this.PostToRuntime("backbutton")}GetNWjsWindow(){return"nwjs"===this._exportType?nw["Window"]["get"]():null}_OnAlert(a){alert(a["message"])}_OnClose(){navigator["app"]&&navigator["app"]["exitApp"]?navigator["app"]["exitApp"]():navigator["device"]&&navigator["device"]["exitApp"]?navigator["device"]["exitApp"]():window.close()}_OnSetFocus(a){const b=a["isFocus"];if("nwjs"===this._exportType){const a=this.GetNWjsWindow();b?a["focus"]():a["blur"]()}else b?window.focus():window.blur()}_OnVibrate(a){navigator["vibrate"]&&navigator["vibrate"](a["pattern"])}_OnLockOrientation(a){const b=a["orientation"];if(screen["orientation"]&&screen["orientation"]["lock"])screen["orientation"]["lock"](b).catch((a)=>console.warn("[Construct 3] Failed to lock orientation: ",a));else try{let a=!1;screen["lockOrientation"]?a=screen["lockOrientation"](b):screen["webkitLockOrientation"]?a=screen["webkitLockOrientation"](b):screen["mozLockOrientation"]?a=screen["mozLockOrientation"](b):screen["msLockOrientation"]&&(a=screen["msLockOrientation"](b)),a||console.warn("[Construct 3] Failed to lock orientation")}catch(a){console.warn("[Construct 3] Failed to lock orientation: ",a)}}_OnUnlockOrientation(){try{screen["orientation"]&&screen["orientation"]["unlock"]?screen["orientation"]["unlock"]():screen["unlockOrientation"]?screen["unlockOrientation"]():screen["webkitUnlockOrientation"]?screen["webkitUnlockOrientation"]():screen["mozUnlockOrientation"]?screen["mozUnlockOrientation"]():screen["msUnlockOrientation"]&&screen["msUnlockOrientation"]()}catch(a){}}_OnNavigate(a){const b=a["type"];if("back"===b)navigator["app"]&&navigator["app"]["backHistory"]?navigator["app"]["backHistory"]():window.back();else if("forward"===b)window.forward();else if("home"===b)window.home();else if("reload"===b)location.reload();else if("url"===b){const b=a["url"],c=a["target"],d=a["exportType"];"windows-uwp"===d&&"undefined"!=typeof Windows?Windows["System"]["Launcher"]["launchUriAsync"](new Windows["Foundation"]["Uri"](b)):navigator["app"]&&navigator["app"]["loadUrl"]?navigator["app"]["loadUrl"](b,{"openExternal":!0}):"cordova"===d?window.open(b,"_system"):"preview"===d?window.open(b,"_blank"):!this._isScirraArcade&&(2===c?window.top.location=b:1===c?window.parent.location=b:window.location=b)}else if("new-window"===b){const b=a["url"],c=a["tag"],d=a["exportType"];"windows-uwp"===d&&"undefined"!=typeof Windows?Windows["System"]["Launcher"]["launchUriAsync"](new Windows["Foundation"]["Uri"](b)):navigator["app"]&&navigator["app"]["loadUrl"]?navigator["app"]["loadUrl"](b,{"openExternal":!0}):"cordova"===d?window.open(b,"_system"):window.open(b,c)}}_OnRequestFullscreen(a){const b={"navigationUI":"auto"},c=a["navUI"];1===c?b["navigationUI"]="hide":2===c&&(b["navigationUI"]="show");const d=document.documentElement;d["requestFullscreen"]?d["requestFullscreen"](b):d["mozRequestFullScreen"]?d["mozRequestFullScreen"](b):d["msRequestFullscreen"]?d["msRequestFullscreen"](b):d["webkitRequestFullScreen"]&&("undefined"==typeof Element["ALLOW_KEYBOARD_INPUT"]?d["webkitRequestFullScreen"]():d["webkitRequestFullScreen"](Element["ALLOW_KEYBOARD_INPUT"]))}_OnExitFullscreen(){document["exitFullscreen"]?document["exitFullscreen"]():document["mozCancelFullScreen"]?document["mozCancelFullScreen"]():document["msExitFullscreen"]?document["msExitFullscreen"]():document["webkitCancelFullScreen"]&&document["webkitCancelFullScreen"]()}};RuntimeInterface.AddDOMHandlerClass(a)}"use strict";{function a(c,a){return!(c.length!==a.length)&&(!(c!==a)||c.toLowerCase()===a.toLowerCase())}const b=class extends DOMHandler{constructor(a){super(a,"audio"),this._audioContext=null,this._destinationNode=null,this._hasUnblocked=!1,this._unblockFunc=()=>this._UnblockAudioContext(),this._audioBuffers=[],this._audioInstances=[],this._lastAudioInstance=null,this._lastPlayedTag="",this._lastTickCount=-1,this._pendingTags=new Map,this._masterVolume=1,this._isSilent=!1,this._timeScaleMode=0,this._timeScale=1,this._gameTime=0,this._panningModel="HRTF",this._distanceModel="inverse",this._refDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._playMusicAsSound=!1,this._hasAnySoftwareDecodedMusic=!1,this._supportsWebMOpus=this._iRuntime.IsAudioFormatSupported("audio/webm; codecs=opus"),this._effects=new Map,this._analysers=new Set,this._isPendingPostFxState=!1,this._microphoneTag="",this._microphoneSource=null,self["C3Audio_OnMicrophoneStream"]=(a,b)=>this._OnMicrophoneStream(a,b),this._destMediaStreamNode=null,self["C3Audio_GetOutputStream"]=()=>this._OnGetOutputStream(),this.AddRuntimeMessageHandlers([["create-audio-context",(a)=>this._CreateAudioContext(a)],["play",(a)=>this._Play(a)],["stop",(a)=>this._Stop(a)],["stop-all",()=>this._StopAll()],["set-paused",(a)=>this._SetPaused(a)],["set-volume",(a)=>this._SetVolume(a)],["fade-volume",(a)=>this._FadeVolume(a)],["set-master-volume",(a)=>this._SetMasterVolume(a)],["set-muted",(a)=>this._SetMuted(a)],["set-silent",(a)=>this._SetSilent(a)],["set-looping",(a)=>this._SetLooping(a)],["set-playback-rate",(a)=>this._SetPlaybackRate(a)],["seek",(a)=>this._Seek(a)],["preload",(a)=>this._Preload(a)],["unload",(a)=>this._Unload(a)],["unload-all",()=>this._UnloadAll()],["set-suspended",(a)=>this._SetSuspended(a)],["add-effect",(a)=>this._AddEffect(a)],["set-effect-param",(a)=>this._SetEffectParam(a)],["remove-effects",(a)=>this._RemoveEffects(a)],["tick",(a)=>this._OnTick(a)],["load-state",(a)=>this._OnLoadState(a)]])}async _CreateAudioContext(a){a["isWKWebView"]&&(this._playMusicAsSound=!0),this._timeScaleMode=a["timeScaleMode"],this._panningModel=["equalpower","HRTF","soundfield"][a["panningModel"]],this._distanceModel=["linear","inverse","exponential"][a["distanceModel"]],this._refDistance=a["refDistance"],this._maxDistance=a["maxDistance"],this._rolloffFactor=a["rolloffFactor"];const b={"latencyHint":a["latencyHint"]};if("undefined"!=typeof AudioContext)this._audioContext=new AudioContext(b);else if("undefined"!=typeof webkitAudioContext)this._audioContext=new webkitAudioContext(b);else throw new Error("Web Audio API not supported");this._destinationNode=this._audioContext["createGain"](),this._destinationNode["connect"](this._audioContext["destination"]);const c=a["listenerPos"];this._audioContext["listener"]["setPosition"](c[0],c[1],c[2]),this._audioContext["listener"]["setOrientation"](0,0,1,0,-1,0),window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),self["C3_GetAudioContextCurrentTime"]=()=>this.GetAudioCurrentTime();try{await Promise.all(a["preloadList"].map((a)=>this._GetAudioBuffer(a["originalUrl"],a["url"],a["type"],!1)))}catch(a){console.error("[Construct 3] Preloading sounds failed: ",a)}return{"sampleRate":this._audioContext["sampleRate"]}}_UnblockAudioContext(){if(!this._hasUnblocked){const a=this._audioContext;"suspended"===a["state"]&&a["resume"]&&a["resume"]();const b=a["createBuffer"](1,220,22050),c=a["createBufferSource"]();c["buffer"]=b,c["connect"](a["destination"]),c["start"](0),"running"===a["state"]&&(this._hasUnblocked=!0,window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._unblockFunc=null)}}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext["currentTime"]}GetDestinationNode(){return this._destinationNode}GetDestinationForTag(a){const b=this._effects.get(a.toLowerCase());return b?b[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(a,b){a=a.toLowerCase();let c=this._effects.get(a);c||(c=[],this._effects.set(a,c)),b._SetIndex(c.length),b._SetTag(a),c.push(b),this._ReconnectEffects(a)}_ReconnectEffects(a){let b=this.GetDestinationNode();const c=this._effects.get(a);if(c&&c.length){b=c[0].GetInputNode();for(let a=0,b=c.length;a<b;++a){const d=c[a];a+1===b?d.ConnectTo(this.GetDestinationNode()):d.ConnectTo(c[a+1].GetInputNode())}}for(const c of this.audioInstancesByTag(a))c.Reconnect(b);this._microphoneSource&&this._microphoneTag===a&&(this._microphoneSource["disconnect"](),this._microphoneSource["connect"](b))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}SupportsWebMOpus(){return this._supportsWebMOpus}_SetHasAnySoftwareDecodedMusic(){this._hasAnySoftwareDecodedMusic=!0}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}DecodeAudioData(a,b){return b?this._iRuntime._WasmDecodeWebMOpus(a).then((a)=>{const b=this._audioContext["createBuffer"](1,a.length,48e3),c=b["getChannelData"](0);return c.set(a),b}):new Promise((b,c)=>{this._audioContext["decodeAudioData"](a,b,c)})}TryPlayMedia(a){this._iRuntime.TryPlayMedia(a)}RemovePendingPlay(a){this._iRuntime.RemovePendingPlay(a)}ReleaseInstancesForBuffer(b){let c=0;for(let d=0,a=this._audioInstances.length;d<a;++d){const e=this._audioInstances[d];this._audioInstances[c]=e,e.GetBuffer()===b?e.Release():++c}this._audioInstances.length=c}ReleaseAllMusicBuffers(){let a=0;for(let c=0,b=this._audioBuffers.length;c<b;++c){const d=this._audioBuffers[c];this._audioBuffers[a]=d,d.IsMusic()?d.Release():++a}this._audioBuffers.length=a}*audioInstancesByTag(b){if(b)for(const c of this._audioInstances)a(c.GetTag(),b)&&(yield c);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(a,b,c,d,e){for(const f of this._audioBuffers)if(f.GetUrl()===b)return await f.Load(),f;if(e)return null;d&&(this._playMusicAsSound||this._hasAnySoftwareDecodedMusic)&&this.ReleaseAllMusicBuffers();const f=C3AudioBuffer.Create(this,a,b,c,d);return this._audioBuffers.push(f),await f.Load(),f}async _GetAudioInstance(a,b,c,d,e){for(const f of this._audioInstances)if(f.GetUrl()===b&&(f.CanBeRecycled()||e))return f.SetTag(d),f;const f=await this._GetAudioBuffer(a,b,c,e),g=f.CreateInstance(d);return this._audioInstances.push(g),g}_AddPendingTag(a){let b=this._pendingTags.get(a);if(!b){let c=null;const d=new Promise((a)=>c=a);b={pendingCount:0,promise:d,resolve:c},this._pendingTags.set(a,b)}b.pendingCount++}_RemovePendingTag(a){const b=this._pendingTags.get(a);if(!b)throw new Error("expected pending tag");b.pendingCount--,0===b.pendingCount&&(b.resolve(),this._pendingTags.delete(a))}TagReady(a){a||(a=this._lastPlayedTag);const b=this._pendingTags.get(a);return b?b.promise:Promise.resolve()}_MaybeStartTicking(){if(0<this._analysers.size)return void this._StartTicking();for(const a of this._audioInstances)if(a.IsActive())return void this._StartTicking()}Tick(){for(const b of this._analysers)b.Tick();const a=this.GetAudioCurrentTime();for(const b of this._audioInstances)b.Tick(a);const b=this._audioInstances.filter((b)=>b.IsActive()).map((b)=>b.GetState());this.PostToRuntime("state",{"tickCount":this._lastTickCount,"audioInstances":b,"analysers":[...this._analysers].map((b)=>b.GetData())}),0===b.length&&0===this._analysers.size&&this._StopTicking()}PostTrigger(a,b){this.PostToRuntime("trigger",{"type":a,"tag":b})}async _Play(a){const b=a["originalUrl"],c=a["url"],d=a["type"],e=a["isMusic"],f=a["tag"],g=a["isLooping"],h=a["vol"],i=a["pos"],j=a["panning"];let k=a["off"];if(0<k&&!a["trueClock"])if(this._audioContext["getOutputTimestamp"]){const a=this._audioContext["getOutputTimestamp"]();k=k-a["performanceTime"]/1e3+a["contextTime"]}else k=k-performance.now()/1e3+this._audioContext["currentTime"];this._lastPlayedTag=f,this._AddPendingTag(f);try{this._lastAudioInstance=await this._GetAudioInstance(b,c,d,f,e),j?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(j["x"],j["y"],j["angle"],j["innerAngle"],j["outerAngle"],j["outerGain"]),j.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(j["uid"])):this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.Play(g,h,i,k)}catch(a){return void console.error("[Construct 3] Audio: error starting playback: ",a)}finally{this._RemovePendingTag(f)}this._StartTicking()}_Stop(a){const b=a["tag"];for(const c of this.audioInstancesByTag(b))c.Stop()}_StopAll(){for(const a of this._audioInstances)a.Stop()}_SetPaused(a){const b=a["tag"],c=a["paused"];for(const d of this.audioInstancesByTag(b))c?d.Pause():d.Resume();this._MaybeStartTicking()}_SetVolume(a){const b=a["tag"],c=a["vol"];for(const d of this.audioInstancesByTag(b))d.SetVolume(c)}async _FadeVolume(a){const b=a["tag"],c=a["vol"],d=a["duration"],e=a["stopOnEnd"];await this.TagReady(b);for(const f of this.audioInstancesByTag(b))f.FadeVolume(c,d,e);this._MaybeStartTicking()}_SetMasterVolume(a){this._masterVolume=a["vol"];for(const b of this._audioInstances)b._UpdateVolume()}_SetMuted(a){const b=a["tag"],c=a["isMuted"];for(const d of this.audioInstancesByTag(b))d.SetMuted(c)}_SetSilent(a){this._isSilent=a["isSilent"],this._iRuntime.SetSilent(this._isSilent);for(const b of this._audioInstances)b._UpdateMuted()}_SetLooping(a){const b=a["tag"],c=a["isLooping"];for(const d of this.audioInstancesByTag(b))d.SetLooping(c)}_SetPlaybackRate(a){const b=a["tag"],c=a["rate"];for(const d of this.audioInstancesByTag(b))d.SetPlaybackRate(c)}_Seek(a){const b=a["tag"],c=a["pos"];for(const d of this.audioInstancesByTag(b))d.Seek(c)}async _Preload(a){const b=a["originalUrl"],c=a["url"],d=a["type"],e=a["isMusic"];try{await this._GetAudioInstance(b,c,d,"",e)}catch(a){console.error("[Construct 3] Audio: error preloading: ",a)}}async _Unload(a){const b=a["url"],c=a["type"],d=a["isMusic"],e=await this._GetAudioBuffer("",b,c,d,!0);if(e){e.Release();const a=this._audioBuffers.indexOf(e);-1!==a&&this._audioBuffers.splice(a,1)}}_UnloadAll(){for(const a of this._audioBuffers)a.Release();this._audioBuffers.length=0}_SetSuspended(a){const b=a["isSuspended"];!b&&this._audioContext["resume"]&&this._audioContext["resume"]();for(const c of this._audioInstances)c.SetSuspended(b);b&&this._audioContext["suspend"]&&this._audioContext["suspend"]()}_OnTick(a){if(this._timeScale=a["timeScale"],this._gameTime=a["gameTime"],this._lastTickCount=a["tickCount"],0!==this._timeScaleMode)for(const a of this._audioInstances)a._UpdatePlaybackRate();const b=a["listenerPos"];b&&this._audioContext["listener"]["setPosition"](b[0],b[1],b[2]);for(const b of a["instPans"]){const a=b["uid"];for(const c of this._audioInstances)c.GetUID()===a&&c.SetPanXYA(b["x"],b["y"],b["angle"])}}async _AddEffect(a){const b=a["type"],c=a["tag"],d=a["params"];let e;if("filter"===b)e=new C3AudioFilterFX(this,...d);else if("delay"===b)e=new C3AudioDelayFX(this,...d);else if("convolution"===b){let b=null;try{b=await this._GetAudioBuffer(a["bufferOriginalUrl"],a["bufferUrl"],a["bufferType"],!1)}catch(a){return void console.log("[Construct 3] Audio: error loading convolution: ",a)}e=new C3AudioConvolveFX(this,b.GetAudioBuffer(),...d),e._SetBufferInfo(a["bufferOriginalUrl"],a["bufferUrl"],a["bufferType"])}else if("flanger"===b)e=new C3AudioFlangerFX(this,...d);else if("phaser"===b)e=new C3AudioPhaserFX(this,...d);else if("gain"===b)e=new C3AudioGainFX(this,...d);else if("tremolo"===b)e=new C3AudioTremoloFX(this,...d);else if("ringmod"===b)e=new C3AudioRingModFX(this,...d);else if("distortion"===b)e=new C3AudioDistortionFX(this,...d);else if("compressor"===b)e=new C3AudioCompressorFX(this,...d);else if("analyser"===b)e=new C3AudioAnalyserFX(this,...d);else throw new Error("invalid effect type");this.AddEffectForTag(c,e),this._PostUpdatedFxState()}_SetEffectParam(a){const b=a["tag"],c=a["index"],d=a["param"],e=a["value"],f=a["ramp"],g=a["time"],h=this._effects.get(b);!h||0>c||c>=h.length||(h[c].SetParam(d,e,f,g),this._PostUpdatedFxState())}_RemoveEffects(a){const b=a["tag"].toLowerCase(),c=this._effects.get(b);if(c&&c.length){for(const a of c)a.Release();this._effects.delete(b),this._ReconnectEffects(b)}}_AddAnalyser(a){this._analysers.add(a),this._MaybeStartTicking()}_RemoveAnalyser(a){this._analysers.delete(a)}_PostUpdatedFxState(){this._isPendingPostFxState||(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const a={};for(const[b,c]of this._effects)a[b]=c.map((a)=>a.GetState());this.PostToRuntime("fxstate",{"fxstate":a}),this._isPendingPostFxState=!1}async _OnLoadState(a){const b=a["saveLoadMode"];if(3!==b)for(const a of this._audioInstances)a.IsMusic()&&1===b||!a.IsMusic()&&2===b||a.Stop();for(const b of this._effects.values())for(const a of b)a.Release();this._effects.clear(),this._timeScale=a["timeScale"],this._gameTime=a["gameTime"];const c=a["listenerPos"];this._audioContext["listener"]["setPosition"](c[0],c[1],c[2]),this._isSilent=a["isSilent"],this._iRuntime.SetSilent(this._isSilent),this._masterVolume=a["masterVolume"];const d=[];for(const b of Object.values(a["effects"]))d.push(Promise.all(b.map((a)=>this._AddEffect(a))));await Promise.all(d),await Promise.all(a["playing"].map((a)=>this._LoadAudioInstance(a,b))),this._MaybeStartTicking()}async _LoadAudioInstance(a,b){if(3===b)return;const c=a["bufferOriginalUrl"],d=a["bufferUrl"],e=a["bufferType"],f=a["isMusic"],g=a["tag"],h=a["isLooping"],i=a["volume"],j=a["playbackTime"];if(f&&1===b)return;if(!f&&2===b)return;let k=null;try{k=await this._GetAudioInstance(c,d,e,g,f)}catch(a){return void console.error("[Construct 3] Audio: error loading audio state: ",a)}k.LoadPanState(a["pan"]),k.Play(h,i,j,0),a["isPlaying"]||k.Pause(),k._LoadAdditionalState(a)}_OnMicrophoneStream(a,b){this._microphoneSource&&this._microphoneSource["disconnect"](),this._microphoneTag=b.toLowerCase(),this._microphoneSource=this._audioContext["createMediaStreamSource"](a),this._microphoneSource["connect"](this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){return this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext["createMediaStreamDestination"](),this._destinationNode["connect"](this._destMediaStreamNode)),this._destMediaStreamNode["stream"]}};RuntimeInterface.AddDOMHandlerClass(b)}"use strict";self.C3AudioBuffer=class{constructor(a,b,c,d,e){this._audioDomHandler=a,this._originalUrl=b,this._url=c,this._type=d,this._isMusic=e,this._api="",this._loadState="not-loaded",this._loadPromise=null}Release(){this._loadState="not-loaded",this._audioDomHandler=null,this._loadPromise=null}static Create(a,b,c,d,e){const f="audio/webm; codecs=opus"===d&&!a.SupportsWebMOpus();return e&&f&&a._SetHasAnySoftwareDecodedMusic(),!e||a.IsPlayMusicAsSound()||f?new C3WebAudioBuffer(a,b,c,d,e,f):new C3Html5AudioBuffer(a,b,c,d,e)}CreateInstance(a){return"html5"===this._api?new C3Html5AudioInstance(this._audioDomHandler,this,a):new C3WebAudioInstance(this._audioDomHandler,this,a)}_Load(){}Load(){return this._loadPromise||(this._loadPromise=this._Load()),this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return"failed"===this._loadState}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}};"use strict";self.C3Html5AudioBuffer=class extends C3AudioBuffer{constructor(a,b,c,d,e){super(a,b,c,d,e),this._api="html5",this._audioElem=new Audio,this._audioElem.crossOrigin="anonymous",this._audioElem.autoplay=!1,this._audioElem.preload="auto",this._loadResolve=null,this._loadReject=null,this._reachedCanPlayThrough=!1,this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0),this._outNode=this.GetAudioContext()["createGain"](),this._mediaSourceNode=null,this._audioElem.addEventListener("canplay",()=>{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadResolve=null,this._loadReject=null);this._mediaSourceNode||!this._audioElem||(this._mediaSourceNode=this.GetAudioContext()["createMediaElementSource"](this._audioElem),this._mediaSourceNode["connect"](this._outNode))}),this.onended=null,this._audioElem.addEventListener("ended",()=>{this.onended&&this.onended()}),this._audioElem.addEventListener("error",(a)=>this._OnError(a))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._outNode["disconnect"](),this._outNode=null,this._mediaSourceNode["disconnect"](),this._mediaSourceNode=null,this._audioElem&&!this._audioElem.paused&&this._audioElem.pause(),this.onended=null,this._audioElem=null,super.Release()}_Load(){return this._loadState="loading",new Promise((a,b)=>{this._loadResolve=a,this._loadReject=b,this._audioElem.src=this._url})}_OnError(a){console.error(`[Construct 3] Audio '${this._url}' error: `,a),this._loadReject&&(this._loadState="failed",this._loadReject(a),this._loadResolve=null,this._loadReject=null)}IsLoaded(){const a=4<=this._audioElem["readyState"];return a&&(this._reachedCanPlayThrough=!0),a||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem["duration"]}};"use strict";self.C3WebAudioBuffer=class extends C3AudioBuffer{constructor(a,b,c,d,e,f){super(a,b,c,d,e),this._api="webaudio",this._audioData=null,this._audioBuffer=null,this._needsSoftwareDecode=!!f}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._audioData=null,this._audioBuffer=null,super.Release()}async _Fetch(){if(this._audioData)return this._audioData;const a=this._audioDomHandler.GetRuntimeInterface();if("cordova"===a.GetExportType()&&a.IsRelativeURL(this._url))this._audioData=await a.CordovaFetchLocalFileAsArrayBuffer(this._url);else{const a=await fetch(this._url);if(!a.ok)throw new Error(`error fetching audio data: ${a.status} ${a.statusText}`);this._audioData=await a.arrayBuffer()}}async _Decode(){return this._audioBuffer?this._audioBuffer:void(this._audioBuffer=await this._audioDomHandler.DecodeAudioData(this._audioData,this._needsSoftwareDecode),this._audioData=null)}async _Load(){try{this._loadState="loading",await this._Fetch(),await this._Decode(),this._loadState="loaded"}catch(a){this._loadState="failed",console.error(`[Construct 3] Failed to load audio '${this._url}': `,a)}}IsLoaded(){return!!(this._audioData||this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer["duration"]:0}};"use strict";{function a(a){return a*b}const b=180/Math.PI;self.C3AudioInstance=class{constructor(a,b,c){this._audioDomHandler=a,this._buffer=b,this._tag=c,this._gainNode=this.GetAudioContext()["createGain"](),this._gainNode["connect"](this.GetDestinationNode()),this._pannerNode=null,this._isPannerEnabled=!1,this._isStopped=!0,this._isPaused=!1,this._resumeMe=!1,this._isLooping=!1,this._volume=1,this._isMuted=!1,this._playbackRate=1;const d=this._audioDomHandler.GetTimeScaleMode();this._isTimescaled=1===d&&!this.IsMusic()||2===d,this._instUid=-1,this._fadeEndTime=-1,this._stopOnFadeEnd=!1}Release(){this._audioDomHandler=null,this._buffer=null,this._pannerNode&&(this._pannerNode["disconnect"](),this._pannerNode=null),this._gainNode["disconnect"](),this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this._tag)}GetMasterVolume(){return this._audioDomHandler.GetMasterVolume()}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/1e3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}SetTag(a){this._tag=a}GetTag(){return this._tag}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(a){let b=this._buffer.GetDuration();return a&&(b/=this._playbackRate||.001),b}Play(){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(a){this._volume=a,this._gainNode["gain"]["cancelScheduledValues"](0),this._fadeEndTime=-1,this._gainNode["gain"]["value"]=this.GetOverallVolume()}FadeVolume(a,b,c){if(!this.IsMuted()){a*=this.GetMasterVolume();const d=this._gainNode["gain"];d["cancelScheduledValues"](0);const e=this._audioDomHandler.GetAudioCurrentTime(),f=e+b;d["setValueAtTime"](this.GetOverallVolume(),e),d["linearRampToValueAtTime"](a,f),this._volume=a,this._fadeEndTime=f,this._stopOnFadeEnd=c}}_UpdateVolume(){this.SetVolume(this._volume)}Tick(a){-1!==this._fadeEndTime&&a>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tag))}GetOverallVolume(){const a=this._volume*this.GetMasterVolume();return isFinite(a)?a:0}SetMuted(a){a=!!a;this._isMuted===a||(this._isMuted=a,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(){}IsLooping(){return this._isLooping}SetPlaybackRate(a){this._playbackRate===a||(this._playbackRate=a,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(){}SetSuspended(){}SetPannerEnabled(a){a=!!a;this._isPannerEnabled===a||(this._isPannerEnabled=a,this._isPannerEnabled?(!this._pannerNode&&(this._pannerNode=this.GetAudioContext()["createPanner"](),this._pannerNode["panningModel"]=this._audioDomHandler.GetPanningModel(),this._pannerNode["distanceModel"]=this._audioDomHandler.GetDistanceModel(),this._pannerNode["refDistance"]=this._audioDomHandler.GetReferenceDistance(),this._pannerNode["maxDistance"]=this._audioDomHandler.GetMaxDistance(),this._pannerNode["rolloffFactor"]=this._audioDomHandler.GetRolloffFactor()),this._gainNode["disconnect"](),this._gainNode["connect"](this._pannerNode),this._pannerNode["connect"](this.GetDestinationNode())):(this._pannerNode["disconnect"](),this._gainNode["disconnect"](),this._gainNode["connect"](this.GetDestinationNode())))}SetPan(b,c,d,e,f,g){this._isPannerEnabled&&(this.SetPanXYA(b,c,d),this._pannerNode["coneInnerAngle"]=a(e),this._pannerNode["coneOuterAngle"]=a(f),this._pannerNode["coneOuterGain"]=g)}SetPanXYA(a,b,c){this._isPannerEnabled&&(this._pannerNode["setPosition"](a,b,0),this._pannerNode["setOrientation"](Math.cos(c),Math.sin(c),0))}SetUID(a){this._instUid=a}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(a){const b=this._pannerNode||this._gainNode;b["disconnect"](),b["connect"](a)}GetState(){return{"tag":this._tag,"duration":this.GetDuration(),"volume":this._volume,"isPlaying":this.IsPlaying(),"playbackTime":this.GetPlaybackTime(),"playbackRate":this.GetPlaybackRate(),"uid":this._instUid,"bufferOriginalUrl":this.GetOriginalUrl(),"bufferUrl":"","bufferType":this.GetContentType(),"isMusic":this.IsMusic(),"isLooping":this.IsLooping(),"isMuted":this.IsMuted(),"resumePosition":this.GetResumePosition(),"pan":this.GetPanState()}}_LoadAdditionalState(a){this.SetPlaybackRate(a["playbackRate"]),this.SetMuted(a["isMuted"])}GetPanState(){if(!this._pannerNode)return null;const a=this._pannerNode;return{"pos":[a["positionX"]["value"],a["positionY"]["value"],a["positionZ"]["value"]],"orient":[a["orientationX"]["value"],a["orientationY"]["value"],a["orientationZ"]["value"]],"cia":a["coneInnerAngle"],"coa":a["coneOuterAngle"],"cog":a["coneOuterGain"],"uid":this._instUid}}LoadPanState(a){if(!a)return void this.SetPannerEnabled(!1);this.SetPannerEnabled(!0);const b=this._pannerNode;b["setPosition"](...b["pos"]),b["setOrientation"](...b["orient"]),b["coneInnerAngle"]=b["cia"],b["coneOuterAngle"]=b["coa"],b["coneOuterGain"]=b["cog"],this._instUid=b["uid"]}}}"use strict";self.C3Html5AudioInstance=class extends C3AudioInstance{constructor(a,b,c){super(a,b,c),this._buffer.GetOutputNode()["connect"](this._gainNode),this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop(),this._buffer.GetOutputNode()["disconnect"](),super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0,this._instUid=-1,this._audioDomHandler.PostTrigger("ended",this._tag)}HasEnded(){return this.GetAudioElement()["ended"]}CanBeRecycled(){return!!this._isStopped||this.HasEnded()}GetPlaybackTime(a){let b=this.GetAudioElement()["currentTime"];return a&&(b*=this._playbackRate),this._isLooping||(b=Math.min(b,this.GetDuration())),b}Play(a,b,c){const d=this.GetAudioElement();if(1!==d.playbackRate&&(d.playbackRate=1),d.loop!==a&&(d.loop=a),this.SetVolume(b),d.muted&&(d.muted=!1),d.currentTime!==c)try{d.currentTime=c}catch(a){console.warn(`[Construct 3] Exception seeking audio '${this._buffer.GetUrl()}' to position '${c}': `,a)}this._audioDomHandler.TryPlayMedia(d),this._isStopped=!1,this._isPaused=!1,this._isLooping=a,this._playbackRate=1}Stop(){const a=this.GetAudioElement();a.paused||a.pause(),this._audioDomHandler.RemovePendingPlay(a),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){if(!(this._isPaused||this._isStopped||this.HasEnded())){const a=this.GetAudioElement();a.paused||a.pause(),this._audioDomHandler.RemovePendingPlay(a),this._isPaused=!0}}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(a){a=!!a;this._isLooping===a||(this._isLooping=a,this.GetAudioElement().loop=a)}_UpdatePlaybackRate(){let a=this._playbackRate;this._isTimescaled&&(a*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement()["playbackRate"]=a}catch(b){console.warn(`[Construct 3] Unable to set playback rate '${a}':`,b)}}Seek(a){if(!(this._isStopped||this.HasEnded()))try{this.GetAudioElement()["currentTime"]=a}catch(b){console.warn(`[Construct 3] Error seeking audio to '${a}': `,b)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(a){a?this.IsPlaying()?(this.GetAudioElement()["pause"](),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}};"use strict";self.C3WebAudioInstance=class extends C3AudioInstance{constructor(a,b,c){super(a,b,c),this._bufferSource=null,this._onended_handler=(a)=>this._OnEnded(a),this._hasPlaybackEnded=!0,this._activeSource=null,this._startTime=0,this._resumePosition=0,this._muteVol=1}Release(){this.Stop(),this._ReleaseBufferSource(),this._onended_handler=null,super.Release()}_ReleaseBufferSource(){this._bufferSource&&this._bufferSource["disconnect"](),this._bufferSource=null,this._activeSource=null}_OnEnded(a){this._isPaused||this._resumeMe||a.target!==this._activeSource||(this._hasPlaybackEnded=!0,this._isStopped=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tag))}HasEnded(){return!(!this._isStopped&&this._bufferSource&&this._bufferSource["loop"])&&!this._isPaused&&this._hasPlaybackEnded}CanBeRecycled(){return!(this._bufferSource&&!this._isStopped)||this.HasEnded()}GetPlaybackTime(a){let b=0;return b=this._isPaused?this._resumePosition:this.GetCurrentTime()-this._startTime,a&&(b*=this._playbackRate),this._isLooping||(b=Math.min(b,this.GetDuration())),b}Play(a,b,c,d){this._muteVol=1,this.SetVolume(b),this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext()["createBufferSource"](),this._bufferSource["buffer"]=this._buffer.GetAudioBuffer(),this._bufferSource["connect"](this._gainNode),this._activeSource=this._bufferSource,this._bufferSource["onended"]=this._onended_handler,this._bufferSource["loop"]=a,this._bufferSource["start"](d,c),this._hasPlaybackEnded=!1,this._isStopped=!1,this._isPaused=!1,this._isLooping=a,this._playbackRate=1,this._startTime=this.GetCurrentTime()-c}Stop(){this._bufferSource&&this._bufferSource["stop"](0),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(!0),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource["stop"](0))}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext()["createBufferSource"](),this._bufferSource["buffer"]=this._buffer.GetAudioBuffer(),this._bufferSource["connect"](this._gainNode),this._activeSource=this._bufferSource,this._bufferSource["onended"]=this._onended_handler,this._bufferSource["loop"]=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._startTime=this.GetCurrentTime()-this._resumePosition/(this._playbackRate||.001),this._bufferSource["start"](0,this._resumePosition),this._isPaused=!1)}GetOverallVolume(){return super.GetOverallVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1,this._UpdateVolume()}SetLooping(a){a=!!a;this._isLooping===a||(this._isLooping=a,this._bufferSource&&(this._bufferSource["loop"]=a))}_UpdatePlaybackRate(){let a=this._playbackRate;this._isTimescaled&&(a*=this._audioDomHandler.GetTimeScale()),this._bufferSource&&(this._bufferSource["playbackRate"]["value"]=a)}Seek(a){this._isStopped||this.HasEnded()||(this._isPaused?this._resumePosition=a:(this.Pause(),this._resumePosition=a,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(a){a?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(!0),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource["stop"](0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext()["createBufferSource"](),this._bufferSource["buffer"]=this._buffer.GetAudioBuffer(),this._bufferSource["connect"](this._gainNode),this._activeSource=this._bufferSource,this._bufferSource["onended"]=this._onended_handler,this._bufferSource["loop"]=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._startTime=this.GetCurrentTime()-this._resumePosition/(this._playbackRate||.001),this._bufferSource["start"](0,this._resumePosition),this._resumeMe=!1)}_LoadAdditionalState(a){super._LoadAdditionalState(a),this._resumePosition=a["resumePosition"]}};"use strict";{function a(a){return Math.pow(10,a/20)}function b(b){return Math.max(Math.min(a(b),1),0)}function c(a){return 20*(Math.log(a)/2.302585092994046)}function d(a){return c(Math.max(Math.min(a,1),0))}function e(a,b){return 1-Math.exp(-b*a)}class f{constructor(a){this._audioDomHandler=a,this._audioContext=a.GetAudioContext(),this._index=-1,this._tag="",this._type="",this._params=null}Release(){this._audioContext=null}_SetIndex(a){this._index=a}GetIndex(){return this._index}_SetTag(a){this._tag=a}GetTag(){return this._tag}CreateGain(){return this._audioContext["createGain"]()}GetInputNode(){}ConnectTo(){}SetAudioParam(a,b,c,d){if(a["cancelScheduledValues"](0),0===d)return void(a["value"]=b);const e=this._audioContext["currentTime"];d+=e,0===c?a["setValueAtTime"](b,d):1===c?(a["setValueAtTime"](a["value"],e),a["linearRampToValueAtTime"](b,d)):2===c?(a["setValueAtTime"](a["value"],e),a["exponentialRampToValueAtTime"](b,d)):void 0}GetState(){return{"type":this._type,"tag":this._tag,"params":this._params}}}self.C3AudioFilterFX=class extends f{constructor(a,b,c,d,e,f,g){super(a),this._type="filter",this._params=[b,c,d,e,f,g],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode["gain"]["value"]=g,this._dryNode=this.CreateGain(),this._dryNode["gain"]["value"]=1-g,this._filterNode=this._audioContext["createBiquadFilter"](),this._filterNode["type"]=b,this._filterNode["frequency"]["value"]=c,this._filterNode["detune"]["value"]=d,this._filterNode["Q"]["value"]=e,this._filterNode["gain"]["vlaue"]=f,this._inputNode["connect"](this._filterNode),this._inputNode["connect"](this._dryNode),this._filterNode["connect"](this._wetNode)}Release(){this._inputNode["disconnect"](),this._filterNode["disconnect"](),this._wetNode["disconnect"](),this._dryNode["disconnect"](),super.Release()}ConnectTo(a){this._wetNode["disconnect"](),this._wetNode["connect"](a),this._dryNode["disconnect"](),this._dryNode["connect"](a)}GetInputNode(){return this._inputNode}SetParam(a,b,c,d){0===a?(b=Math.max(Math.min(b/100,1),0),this._params[5]=b,this.SetAudioParam(this._wetNode["gain"],b,c,d),this.SetAudioParam(this._dryNode["gain"],1-b,c,d)):1===a?(this._params[1]=b,this.SetAudioParam(this._filterNode["frequency"],b,c,d)):2===a?(this._params[2]=b,this.SetAudioParam(this._filterNode["detune"],b,c,d)):3===a?(this._params[3]=b,this.SetAudioParam(this._filterNode["Q"],b,c,d)):4===a?(this._params[4]=b,this.SetAudioParam(this._filterNode["gain"],b,c,d)):void 0}},self.C3AudioDelayFX=class extends f{constructor(a,b,c,d){super(a),this._type="delay",this._params=[b,c,d],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode["gain"]["value"]=d,this._dryNode=this.CreateGain(),this._dryNode["gain"]["value"]=1-d,this._mainNode=this.CreateGain(),this._delayNode=this._audioContext["createDelay"](b),this._delayNode["delayTime"]["value"]=b,this._delayGainNode=this.CreateGain(),this._delayGainNode["gain"]["value"]=c,this._inputNode["connect"](this._mainNode),this._inputNode["connect"](this._dryNode),this._mainNode["connect"](this._wetNode),this._mainNode["connect"](this._delayNode),this._delayNode["connect"](this._delayGainNode),this._delayGainNode["connect"](this._mainNode)}Release(){this._inputNode["disconnect"](),this._wetNode["disconnect"](),this._dryNode["disconnect"](),this._mainNode["disconnect"](),this._delayNode["disconnect"](),this._delayGainNode["disconnect"](),super.Release()}ConnectTo(a){this._wetNode["disconnect"](),this._wetNode["connect"](a),this._dryNode["disconnect"](),this._dryNode["connect"](a)}GetInputNode(){return this._inputNode}SetParam(a,c,d,e){0===a?(c=Math.max(Math.min(c/100,1),0),this._params[2]=c,this.SetAudioParam(this._wetNode["gain"],c,d,e),this.SetAudioParam(this._dryNode["gain"],1-c,d,e)):4===a?(this._params[1]=b(c),this.SetAudioParam(this._delayGainNode["gain"],b(c),d,e)):5===a?(this._params[0]=c,this.SetAudioParam(this._delayNode["delayTime"],c,d,e)):void 0}},self.C3AudioConvolveFX=class extends f{constructor(a,b,c,d){super(a),this._type="convolution",this._params=[c,d],this._bufferOriginalUrl="",this._bufferUrl="",this._bufferType="",this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode["gain"]["value"]=d,this._dryNode=this.CreateGain(),this._dryNode["gain"]["value"]=1-d,this._convolveNode=this._audioContext["createConvolver"](),this._convolveNode["normalize"]=c,this._convolveNode["buffer"]=b,this._inputNode["connect"](this._convolveNode),this._inputNode["connect"](this._dryNode),this._convolveNode["connect"](this._wetNode)}Release(){this._inputNode["disconnect"](),this._convolveNode["disconnect"](),this._wetNode["disconnect"](),this._dryNode["disconnect"](),super.Release()}ConnectTo(a){this._wetNode["disconnect"](),this._wetNode["connect"](a),this._dryNode["disconnect"](),this._dryNode["connect"](a)}GetInputNode(){return this._inputNode}SetParam(a,b,c,d){0===a?(b=Math.max(Math.min(b/100,1),0),this._params[1]=b,this.SetAudioParam(this._wetNode["gain"],b,c,d),this.SetAudioParam(this._dryNode["gain"],1-b,c,d)):void 0}_SetBufferInfo(a,b,c){this._bufferOriginalUrl=a,this._bufferUrl=b,this._bufferType=c}GetState(){const a=super.GetState();return a["bufferOriginalUrl"]=this._bufferOriginalUrl,a["bufferUrl"]="",a["bufferType"]=this._bufferType,a}},self.C3AudioFlangerFX=class extends f{constructor(a,b,c,d,e,f){super(a),this._type="flanger",this._params=[b,c,d,e,f],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode["gain"]["value"]=1-f/2,this._wetNode=this.CreateGain(),this._wetNode["gain"]["value"]=f/2,this._feedbackNode=this.CreateGain(),this._feedbackNode["gain"]["value"]=e,this._delayNode=this._audioContext["createDelay"](b+c),this._delayNode["delayTime"]["value"]=b,this._oscNode=this._audioContext["createOscillator"](),this._oscNode["frequency"]["value"]=d,this._oscGainNode=this.CreateGain(),this._oscGainNode["gain"]["value"]=c,this._inputNode["connect"](this._delayNode),this._inputNode["connect"](this._dryNode),this._delayNode["connect"](this._wetNode),this._delayNode["connect"](this._feedbackNode),this._feedbackNode["connect"](this._delayNode),this._oscNode["connect"](this._oscGainNode),this._oscGainNode["connect"](this._delayNode["delayTime"]),this._oscNode["start"](0)}Release(){this._oscNode["stop"](0),this._inputNode["disconnect"](),this._delayNode["disconnect"](),this._oscNode["disconnect"](),this._oscGainNode["disconnect"](),this._dryNode["disconnect"](),this._wetNode["disconnect"](),this._feedbackNode["disconnect"](),super.Release()}ConnectTo(a){this._wetNode["disconnect"](),this._wetNode["connect"](a),this._dryNode["disconnect"](),this._dryNode["connect"](a)}GetInputNode(){return this._inputNode}SetParam(a,b,c,d){0===a?(b=Math.max(Math.min(b/100,1),0),this._params[4]=b,this.SetAudioParam(this._wetNode["gain"],b/2,c,d),this.SetAudioParam(this._dryNode["gain"],1-b/2,c,d)):6===a?(this._params[1]=b/1e3,this.SetAudioParam(this._oscGainNode["gain"],b/1e3,c,d)):7===a?(this._params[2]=b,this.SetAudioParam(this._oscNode["frequency"],b,c,d)):8===a?(this._params[3]=b/100,this.SetAudioParam(this._feedbackNode["gain"],b/100,c,d)):void 0}},self.C3AudioPhaserFX=class extends f{constructor(a,b,c,d,e,f,g){super(a),this._type="phaser",this._params=[b,c,d,e,f,g],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode["gain"]["value"]=1-g/2,this._wetNode=this.CreateGain(),this._wetNode["gain"]["value"]=g/2,this._filterNode=this._audioContext["createBiquadFilter"](),this._filterNode["type"]="allpass",this._filterNode["frequency"]["value"]=b,this._filterNode["detune"]["value"]=c,this._filterNode["Q"]["value"]=d,this._oscNode=this._audioContext["createOscillator"](),this._oscNode["frequency"]["value"]=f,this._oscGainNode=this.CreateGain(),this._oscGainNode["gain"]["value"]=e,this._inputNode["connect"](this._filterNode),this._inputNode["connect"](this._dryNode),this._filterNode["connect"](this._wetNode),this._oscNode["connect"](this._oscGainNode),this._oscGainNode["connect"](this._filterNode["frequency"]),this._oscNode["start"](0)}Release(){this._oscNode["stop"](0),this._inputNode["disconnect"](),this._filterNode["disconnect"](),this._oscNode["disconnect"](),this._oscGainNode["disconnect"](),this._dryNode["disconnect"](),this._wetNode["disconnect"](),super.Release()}ConnectTo(a){this._wetNode["disconnect"](),this._wetNode["connect"](a),this._dryNode["disconnect"](),this._dryNode["connect"](a)}GetInputNode(){return this._inputNode}SetParam(a,b,c,d){0===a?(b=Math.max(Math.min(b/100,1),0),this._params[5]=b,this.SetAudioParam(this._wetNode["gain"],b/2,c,d),this.SetAudioParam(this._dryNode["gain"],1-b/2,c,d)):1===a?(this._params[0]=b,this.SetAudioParam(this._filterNode["frequency"],b,c,d)):2===a?(this._params[1]=b,this.SetAudioParam(this._filterNode["detune"],b,c,d)):3===a?(this._params[2]=b,this.SetAudioParam(this._filterNode["Q"],b,c,d)):6===a?(this._params[3]=b,this.SetAudioParam(this._oscGainNode["gain"],b,c,d)):7===a?(this._params[4]=b,this.SetAudioParam(this._oscNode["frequency"],b,c,d)):void 0}},self.C3AudioGainFX=class extends f{constructor(a,b){super(a),this._type="gain",this._params=[b],this._node=this.CreateGain(),this._node["gain"]["value"]=b}Release(){this._node["disconnect"](),super.Release()}ConnectTo(a){this._node["disconnect"](),this._node["connect"](a)}GetInputNode(){return this._node}SetParam(a,c,d,e){4===a?(this._params[0]=b(c),this.SetAudioParam(this._node["gain"],b(c),d,e)):void 0}},self.C3AudioTremoloFX=class extends f{constructor(a,b,c){super(a),this._type="tremolo",this._params=[b,c],this._node=this.CreateGain(),this._node["gain"]["value"]=1-c/2,this._oscNode=this._audioContext["createOscillator"](),this._oscNode["frequency"]["value"]=b,this._oscGainNode=this.CreateGain(),this._oscGainNode["gain"]["value"]=c/2,this._oscNode["connect"](this._oscGainNode),this._oscGainNode["connect"](this._node["gain"]),this._oscNode["start"](0)}Release(){this._oscNode["stop"](0),this._oscNode["disconnect"](),this._oscGainNode["disconnect"](),this._node["disconnect"](),super.Release()}ConnectTo(a){this._node["disconnect"](),this._node["connect"](a)}GetInputNode(){return this._node}SetParam(a,b,c,d){0===a?(b=Math.max(Math.min(b/100,1),0),this._params[1]=b,this.SetAudioParam(this._node["gain"]["value"],1-b/2,c,d),this.SetAudioParam(this._oscGainNode["gain"]["value"],b/2,c,d)):7===a?(this._params[0]=b,this.SetAudioParam(this._oscNode["frequency"],b,c,d)):void 0}},self.C3AudioRingModFX=class extends f{constructor(a,b,c){super(a),this._type="ringmod",this._params=[b,c],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode["gain"]["value"]=c,this._dryNode=this.CreateGain(),this._dryNode["gain"]["value"]=1-c,this._ringNode=this.CreateGain(),this._ringNode["gain"]["value"]=0,this._oscNode=this._audioContext["createOscillator"](),this._oscNode["frequency"]["value"]=b,this._oscNode["connect"](this._ringNode["gain"]),this._oscNode["start"](0),this._inputNode["connect"](this._ringNode),this._inputNode["connect"](this._dryNode),this._ringNode["connect"](this._wetNode)}Release(){this._oscNode["stop"](0),this._oscNode["disconnect"](),this._ringNode["disconnect"](),this._inputNode["disconnect"](),this._wetNode["disconnect"](),this._dryNode["disconnect"](),super.Release()}ConnectTo(a){this._wetNode["disconnect"](),this._wetNode["connect"](a),this._dryNode["disconnect"](),this._dryNode["connect"](a)}GetInputNode(){return this._inputNode}SetParam(a,b,c,d){0===a?(b=Math.max(Math.min(b/100,1),0),this._params[1]=b,this.SetAudioParam(this._wetNode["gain"],b,c,d),this.SetAudioParam(this._dryNode["gain"],1-b,c,d)):7===a?(this._params[0]=b,this.SetAudioParam(this._oscNode["frequency"],b,c,d)):void 0}},self.C3AudioDistortionFX=class extends f{constructor(a,b,c,d,e,f){super(a),this._type="distortion",this._params=[b,c,d,e,f],this._inputNode=this.CreateGain(),this._preGain=this.CreateGain(),this._postGain=this.CreateGain(),this._SetDrive(d,e),this._wetNode=this.CreateGain(),this._wetNode["gain"]["value"]=f,this._dryNode=this.CreateGain(),this._dryNode["gain"]["value"]=1-f,this._waveShaper=this._audioContext["createWaveShaper"](),this._curve=new Float32Array(65536),this._GenerateColortouchCurve(b,c),this._waveShaper.curve=this._curve,this._inputNode["connect"](this._preGain),this._inputNode["connect"](this._dryNode),this._preGain["connect"](this._waveShaper),this._waveShaper["connect"](this._postGain),this._postGain["connect"](this._wetNode)}Release(){this._inputNode["disconnect"](),this._preGain["disconnect"](),this._waveShaper["disconnect"](),this._postGain["disconnect"](),this._wetNode["disconnect"](),this._dryNode["disconnect"](),super.Release()}_SetDrive(a,b){.01>a&&(a=.01),this._preGain["gain"]["value"]=a,this._postGain["gain"]["value"]=Math.pow(1/a,.6)*b}_GenerateColortouchCurve(a,b){for(let c,d=0;d<32768;++d)c=d/32768,c=this._Shape(c,a,b),this._curve[32768+d]=c,this._curve[32768-d-1]=-c}_Shape(a,b,c){const d=1.05*c*b-b,f=0>a?-1:1,g=0>a?-a:a;let h=g<b?g:b+d*e(g-b,1/d);return h*=f,h}ConnectTo(a){this._wetNode["disconnect"](),this._wetNode["connect"](a),this._dryNode["disconnect"](),this._dryNode["connect"](a)}GetInputNode(){return this._inputNode}SetParam(a,b,c,d){0===a?(b=Math.max(Math.min(b/100,1),0),this._params[4]=b,this.SetAudioParam(this._wetNode["gain"],b,c,d),this.SetAudioParam(this._dryNode["gain"],1-b,c,d)):void 0}},self.C3AudioCompressorFX=class extends f{constructor(a,b,c,d,e,f){super(a),this._type="compressor",this._params=[b,c,d,e,f],this._node=this._audioContext["createDynamicsCompressor"](),this._node["threshold"]["value"]=b,this._node["knee"]["value"]=c,this._node["ratio"]["value"]=d,this._node["attack"]["value"]=e,this._node["release"]["value"]=f}Release(){this._node["disconnect"](),super.Release()}ConnectTo(a){this._node["disconnect"](),this._node["connect"](a)}GetInputNode(){return this._node}SetParam(){}},self.C3AudioAnalyserFX=class extends f{constructor(a,b,c){super(a),this._type="analyser",this._params=[b,c],this._node=this._audioContext["createAnalyser"](),this._node["fftSize"]=b,this._node["smoothingTimeConstant"]=c,this._freqBins=new Float32Array(this._node["frequencyBinCount"]),this._signal=new Uint8Array(b),this._peak=0,this._rms=0,this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this),this._node["disconnect"](),super.Release()}Tick(){this._node["getFloatFrequencyData"](this._freqBins),this._node["getByteTimeDomainData"](this._signal);const a=this._node["fftSize"];this._peak=0;let b=0;for(let c,d=0;d<a;++d)c=(this._signal[d]-128)/128,0>c&&(c=-c),this._peak<c&&(this._peak=c),b+=c*c;this._peak=d(this._peak),this._rms=d(Math.sqrt(b/a))}ConnectTo(a){this._node["disconnect"](),this._node["connect"](a)}GetInputNode(){return this._node}SetParam(){}GetData(){return{"tag":this.GetTag(),"index":this.GetIndex(),"peak":this._peak,"rms":this._rms,"binCount":this._node["frequencyBinCount"],"freqBins":this._freqBins}}}}